<project name="chionographis" default="classes">

  <target name="classes" depends="-compile,-archive"/>

  <target name="-compile">
    <delete dir="release/classes"/>
    <mkdir dir="release/classes"/>
    <javac srcdir="src" includes="net/furfurylic/chionographis/**/*.java"
      destdir="release/classes" nowarn="yes" source="1.8" debug="yes"
      debuglevel="source,lines" includeantruntime="yes"/>
  </target>

  <target name="-archive" depends="-make-archive,-rev,-update-archive-rev,-update-archive-spec"/>

  <target name="-make-archive">
    <delete dir="release/lib"/>
    <mkdir dir="release/lib"/>
    <jar destfile="release/lib/chionographis.jar" basedir="release/classes"
      includes="**/*" update="no" filesonly="yes" index="yes" level="9">
      <manifest>
        <attribute name="Sealed" value="true"/>
        <attribute name="Specification-Title" value="Chionographis"/>
        <attribute name="Implementation-Title" value="net.furfurylic.chionographis"/>
        <attribute name="Main-Class" value="net.furfurylic.chionographis.Main"/>
      </manifest>
    </jar>
  </target>

  <target name="-update-archive-rev" if="rev.number">
    <jar destfile="release/lib/chionographis.jar" update="yes" filesonly="yes" level="9">
      <manifest>
        <attribute name="Implementation-Version" value="${rev.number}"/>
      </manifest>
    </jar>
  </target>

  <target name="-update-archive-spec" if="rev.spec">
    <jar destfile="release/lib/chionographis.jar" update="yes" filesonly="yes" level="9">
      <manifest>
        <attribute name="Specification-Version" value="${rev.spec}"/>
      </manifest>
    </jar>
  </target>

  <target name="api-docs" depends="-rev,-api-docs-spec,-api-docs-no-spec,-api-docs-fallback"/>

  <target name="-api-docs-spec" if="${rev.isbase}">
    <delete dir="release/doc/api"/>
    <mkdir dir="release/doc/api"/>
    <javadoc locale="en" packagenames="net.furfurylic.chionographis.*"
      sourcepath="src" destdir="release/doc/api" encoding="UTF-8" docencoding="UTF-8"
      charset="UTF-8" windowtitle="Chionographis API version ${rev.spec} (${rev.number})"
      doctitle="Chionographis API v${rev.spec}" header="Chionographis API v${rev.spec}"
      classpath="${ant.home}/lib/ant.jar" use="yes"/>
    <property name="api-docs.made" value="true"/>
  </target>

  <target name="-api-docs-no-spec" if="${rev.isnotbase}">
    <delete dir="release/doc/api"/>
    <mkdir dir="release/doc/api"/>
    <javadoc locale="en" packagenames="net.furfurylic.chionographis.*"
      sourcepath="src" destdir="release/doc/api" encoding="UTF-8" docencoding="UTF-8"
      charset="UTF-8" windowtitle="Chionographis API (version ${rev.number})"
      doctitle="Chionographis API" header="Chionographis API"
      classpath="${ant.home}/lib/ant.jar" use="yes"/>
    <property name="api-docs.made" value="true"/>
  </target>

  <target name="-api-docs-fallback" unless="${api-docs.made}">
    <delete dir="release/doc/api"/>
    <mkdir dir="release/doc/api"/>
    <javadoc locale="en" packagenames="net.furfurylic.chionographis.*"
      sourcepath="src" destdir="release/doc/api" encoding="UTF-8" docencoding="UTF-8"
      charset="UTF-8" windowtitle="Chionographis API"
      doctitle="Chionographis API" header="Chionographis API"
      classpath="${ant.home}/lib/ant.jar" use="yes"/>
    <property name="api-docs.made" value="true"/>
  </target>

  <target name="-rev" depends="-git-check,-rev-all"/>

  <target name="-git-check">
    <exec executable="git" resultproperty="git.exitcode"
      failonerror="false" failifexecutionfails="false">
      <arg line="status"/>
      <arg line="-s"/>
    </exec>
    <condition property="git.available" else="false">
      <equals arg1="${git.exitcode}" arg2="0"/>
    </condition>
  </target>

  <target name="-rev-all" depends="-rev-number,-rev-spec,-rev-date"/>

  <target name="-rev-number" if="${git.available}">
    <mkdir dir="release/rev"/>
    <exec executable="git" output="release/rev/number">
      <arg line="describe" />
      <arg line="--tags" />
    </exec>
    <replaceregexp file="release/rev/number" match="^[\s]*v([\S]+)[\s]*$" replace="\1"/>
    <loadfile property="rev.number" srcfile="release/rev/number"/>
    <copy file="release/rev/number" tofile="release/rev/base"/>
    <replaceregexp file="release/rev/base" match="^[\s]*([\d]+\.[\d]+\.[\d]+).*$" replace="\1"/>
    <loadfile property="rev.base" srcfile="release/rev/base"/>
    <delete dir="release/rev"/>
  </target>

  <target name="-rev-isbase" if="${git.available}" depends="-rev-number">
    <condition property="rev.isbase" else="false">
      <equals arg1="${rev.number}" arg2="${rev.base}"/>
    </condition>
    <condition property="rev.isnotbase" else="false">
      <isset property="rev.isbase"/>
    </condition>
  </target>

  <target name="-rev-spec" if="${rev.isbase}" depends="-rev-number,-rev-isbase">
    <mkdir dir="release/rev"/>
    <echo message="${rev.base}" file="release/rev/spec"/>
    <echo>hoge</echo>
    <replaceregexp file="release/rev/spec" match="^[\s]*([\d]+\.[\d]+).*$" replace="\1"/>
    <loadfile property="rev.spec" srcfile="release/rev/spec"/>
    <delete dir="release/rev"/>
  </target>

  <target name="-rev-date" if="${git.available}">
    <mkdir dir="release/rev"/>
    <exec executable="git" output="release/rev/date">
      <arg line="log"/>
      <arg line="-1"/>
      <arg line="--date=iso"/>
      <arg line="--format='%cd'"/>
     </exec>
    <replaceregexp file="release/rev/date" match="^[\s]*([\S]+)[\s]$" replace="\1"/>
    <loadfile property="rev.date" srcfile="release/rev/date"/>
    <delete dir="release/rev"/>
  </target>

  <target name="users-guide" depends="-rev,-users-guide-rev,-users-guide-no-rev"/>

  <target name="-users-guide-rev" if="rev.number">
    <mkdir dir="release/doc"/>
    <exec executable="asciidoc" failonerror="true">
      <arg line="-b html5"/>
      <arg line="-a toc"/>
      <arg line="-n"/>
      <arg line="-o release/doc/UsersGuide.html"/>
      <arg line="-a revnumber=${rev.number}"/>
      <arg line="-a revdate='${rev.date}'"/>
      <arg line="UsersGuide.asciidoc"/>
    </exec>
  </target>

  <target name="-users-guide-no-rev" unless="rev.number">
    <mkdir dir="release/doc"/>
    <exec executable="asciidoc" failonerror="true">
      <arg line="-b html5"/>
      <arg line="-a toc"/>
      <arg line="-n"/>
      <arg line="-o release/doc/UsersGuide.html"/>
      <arg line="UsersGuide.asciidoc"/>
    </exec>
  </target>

  <target name="release" depends="classes,api-docs,users-guide">
    <zip destfile="release/doc/api.zip" basedir="release/doc/api" level="9"/>
    <delete dir="release/classes"/>
    <delete dir="release/doc/api"/>
  </target>

  <target name="api-docs-devel">
    <delete dir="devel/doc/api"/>
    <mkdir dir="devel/doc/api"/>
    <javadoc locale="en" packagenames="net.furfurylic.chionographis.*"
      sourcepath="src" destdir="devel/doc/api" encoding="UTF-8" docencoding="UTF-8"
      charset="UTF-8" windowtitle="Chionographis API for developers"
      doctitle="Chionographis API for developers"
      header="Chionographis API for developers"
      classpath="${ant.home}/lib/ant.jar" access="package" use="yes"/>
  </target>

</project>
