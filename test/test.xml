<project name="chinographis-test" basedir="." default="full">

  <taskdef name="chionographis" classname="net.furfurylic.chionographis.Chionographis"/>
  <typedef name="depends" classname="net.furfurylic.chionographis.Depends"/>

  <target name="full">
    <antcall target="basic-mapper"/>
    <antcall target="basic-mapper-dry"/>
    <antcall target="basic-mapper-dry-prop"/>
    <antcall target="basic-mapper-not-dry-prop"/>
    <antcall target="basic-mapper-up-to-date"/>
    <antcall target="basic-not-up-to-date-by-depends-new"/>
    <antcall target="basic-up-to-date-by-depends-ignore"/>
    <antcall target="basic-complex-depends"/>
    <antcall target="basic-error-depends-fail"/>
    <antcall target="basic-error-depends"/>
    <antcall target="basic-refer-content"/>
    <antcall target="basic-force-output"/>
    <antcall target="basic-force-task"/>
    <antcall target="basic-up-to-date-at-start"/>
    <antcall target="basic-not-up-to-date-at-start-by-depends"/>
    <antcall target="basic-force-at-start"/>
    <antcall target="basic-meta"/>
    <antcall target="basic-meta-uri"/>
    <antcall target="basic-meta-title-no-extension"/>
    <antcall target="basic-error-meta-no-name-no-type"/>
    <antcall target="basic-error-meta-no-type"/>
    <antcall target="basic-error-meta-bad-type"/>
    <antcall target="basic-error-meta-empty-type"/>
    <antcall target="basic-error-meta-bad-name"/>
    <antcall target="basic-error-meta-empty-name"/>
    <antcall target="basic-meta-added-twice"/>
    <antcall target="basic-meta-refer-content"/>
    <antcall target="basic-error-namespace-no-prefix-no-uri"/>
    <antcall target="basic-error-namespace-no-prefix"/>
    <antcall target="basic-error-namespace-no-uri"/>
    <antcall target="basic-error-namespace-bad-prefix"/>
    <antcall target="basic-error-namespace-empty-prefix"/>
    <antcall target="basic-error-namespace-added-twice"/>
    <antcall target="basic-error-no-sinks"/>
    <antcall target="basic-error-output-mapper-added-twice"/>
    <antcall target="basic-error-output-dest-and-mapper"/>
    <antcall target="basic-error-output-dest-and-refer"/>
    <antcall target="basic-error-output-no-clue"/>
    <antcall target="basic-error-output-bad-refer"/>
    <antcall target="basic-no-matching-input"/>
    <antcall target="basic-output-no-mapped"/>
    <antcall target="transform"/>
    <antcall target="transform-error-no-stylesheet-configured"/>
    <antcall target="transform-error-stylesheet"/>
    <antcall target="transform-params"/>
    <antcall target="transform-params-ns"/>
    <antcall target="transform-assoc"/>
    <antcall target="transform-error-params-bad-prefix"/>
    <antcall target="transform-error-params-no-name-no-value"/>
    <antcall target="transform-error-params-no-name"/>
    <antcall target="transform-error-params-empty-name"/>
    <antcall target="transform-error-params-added-twice"/>
    <antcall target="transform-error-params-value-format"/>
    <antcall target="transform-error-style-and-assoc"/>
    <antcall target="transform-refer-content"/>
    <antcall target="transform-not-up-to-date"/>
    <antcall target="transform-not-up-to-date-at-start"/>
    <antcall target="transform-not-up-to-date-by-depends"/>
    <antcall target="transform-not-up-to-date-by-depends-new"/>
    <antcall target="transform-force"/>
    <antcall target="all"/>
    <antcall target="all-up-to-date"/>
    <antcall target="all-up-to-date-late"/>
    <antcall target="all-not-up-to-date-late"/>
    <antcall target="all-ns"/>
    <antcall target="all-error-bad-prefix"/>
    <antcall target="all-force"/>
    <antcall target="snip-1"/>
    <antcall target="snip-2"/>
    <antcall target="snip-ns"/>
    <antcall target="snip-error-bad-xpath"/>
    <antcall target="crossing-cache"/>
    <antcall target="crossing-cache-refer-content"/>
    <antcall target="crossing-timid"/>
    <antcall target="crossing-parallel-sinks"/>
    <antcall target="crossing-abort-sources"/>
    <antcall target="crossing-abort-sinks-dom"/>
    <antcall target="crossing-abort-sinks-sax"/>
  </target>

  <script language="javascript"><![CDATA[
    if ("true".equalsIgnoreCase(
          project.getProperty("net.furfurylic.chionographis.squelch"))) {
      System = Java.type("java.lang.System");
      System.setErr(new java.io.PrintStream(new java.io.ByteArrayOutputStream()));
    }
  ]]></script>

  <fail message="Run this with dry run mode not specified">
    <condition>
      <or>
        <equals arg1="${net.furfurylic.chionographis.dry-run}"
          arg2="true" casesensitive="no"/>
        <equals arg1="${net.furfurylic.chionographis.dry-run}"
          arg2="false" casesensitive="no"/>
      </or>
    </condition>
  </fail>

  <macrodef name="assertfilenotexists">
    <attribute name="name"/>
    <attribute name="file"/>
    <sequential>
      <fail message="@{name}: @{file} DOES exist">
        <condition><resourceexists><file file="@{file}"/></resourceexists></condition>
      </fail>
    </sequential>
  </macrodef>

  <macrodef name="assertfileeq">
    <attribute name="name"/>
    <attribute name="expected"/>
    <attribute name="actual"/>
    <sequential>
      <fail message="@{name}: @{actual} doesn't exist">
        <condition>
          <not><resourceexists><file file="@{actual}"/></resourceexists></not>
        </condition>
      </fail>
      <fail message="@{name}: @{expected} doesn't exist">
        <condition>
          <not><resourceexists><file file="@{expected}"/></resourceexists></not>
        </condition>
      </fail>
      <fail message="@{name}: @{actual} doesn't match with @{expected}">
        <condition>
          <not><filesmatch file1="@{actual}" file2="@{expected}"/></not>
        </condition>
      </fail>
    </sequential>
  </macrodef>

  <macrodef name="assertfileeq2">
    <attribute name="name"/>
    <attribute name="expected1"/>
    <attribute name="expected2"/>
    <attribute name="actual"/>
    <sequential>
      <fail message="@{name}: @{actual} doesn't exist">
        <condition>
          <not><resourceexists><file file="@{actual}"/> </resourceexists></not>
        </condition>
      </fail>
      <fail message="@{name}: @{expected1} doesn't exist">
        <condition>
          <not><resourceexists><file file="@{expected1}"/> </resourceexists></not>
        </condition>
      </fail>
      <fail message="@{name}: @{expected2} doesn't exist">
        <condition>
          <not><resourceexists><file file="@{expected2}"/> </resourceexists></not>
        </condition>
      </fail>
      <fail message="@{name}: @{actual} doesn't match with neither @{expected1} nor @{expected2}">
        <condition>
          <not>
            <or>
              <filesmatch file1="@{actual}" file2="@{expected1}"/>
              <filesmatch file1="@{actual}" file2="@{expected2}"/>
            </or>
          </not>
        </condition>
      </fail>
    </sequential>
  </macrodef>

  <macrodef name="assertfilelastmodified">
    <attribute name="name"/>
    <attribute name="file"/>
    <attribute name="datetime"/>
    <sequential>
      <fail message="@{name}: @{file} doesn't exist">
        <condition>
          <not><resourceexists><file file="@{file}"/></resourceexists></not>
        </condition>
      </fail>
      <fail message="@{name}: @{file} doesn't have last modified time &quot;@{datetime}&quot;">
        <condition>
          <not>
            <islastmodified datetime="@{datetime}" mode="equals">
              <file file="@{file}"/>
            </islastmodified>
          </not>
        </condition>
      </fail>
    </sequential>
  </macrodef>

  <target name="-require-dry-by-prop">
    <property name="net.furfurylic.chionographis.dry-run" value="true"/>
  </target>

  <target name="-require-not-dry-by-prop">
    <property name="net.furfurylic.chionographis.dry-run" value="false"/>
  </target>

  <target name="basic-mapper">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="mapper"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis basedir="${test.prefix}" srcdir="input" includes="*.xml" cache="no"
      verbose="yes">
      <output destdir="output-${test.title}">
        <globmapper from="input*.xml" to="output*.xml"/>
      </output>
    </chionographis>

    <xslt style="${basedir}/flatten.xsl"
          basedir="${dir.output}" destdir="${dir.output}" includes="*.xml">
      <globmapper from="output*.xml" to="actual*.txt"/>
    </xslt>
    <assertfileeq name="${test.name} - 1"
                  expected="${dir.input}/expected1.txt" actual="${dir.output}/actual1.txt"/>
    <assertfileeq name="${test.name} - 2"
                  expected="${dir.input}/expected2.txt" actual="${dir.output}/actual2.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="basic-mapper-dry">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="mapper-dry"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis basedir="${test.prefix}" srcdir="input" includes="*.xml" cache="no"
      verbose="yes" dryrun="yes">
      <output destdir="output-${test.title}">
        <globmapper from="input*.xml" to="output*.xml"/>
      </output>
    </chionographis>

    <assertfilenotexists name="${test.name}" file="${dir.output}"/>
  </target>

  <target name="basic-mapper-dry-prop" depends="-require-dry-by-prop">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="mapper-dry-prop"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis basedir="${test.prefix}" srcdir="input" includes="*.xml" cache="no"
      verbose="yes" dryrun="no">
      <output destdir="output-${test.title}">
        <globmapper from="input*.xml" to="output*.xml"/>
      </output>
    </chionographis>

    <assertfilenotexists name="${test.name}" file="${dir.output}"/>
  </target>

  <target name="basic-mapper-not-dry-prop" depends="-require-not-dry-by-prop">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="mapper-not-dry-prop"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis basedir="${test.prefix}" srcdir="input" includes="*.xml" cache="no"
      verbose="yes" dryrun="yes">
      <output destdir="output-${test.title}">
        <globmapper from="input*.xml" to="output*.xml"/>
      </output>
    </chionographis>

    <xslt style="${basedir}/flatten.xsl"
          basedir="${dir.output}" destdir="${dir.output}" includes="*.xml">
      <globmapper from="output*.xml" to="actual*.txt"/>
    </xslt>
    <assertfileeq name="${test.name} - 1"
                  expected="${dir.input}/expected1.txt" actual="${dir.output}/actual1.txt"/>
    <assertfileeq name="${test.name} - 2"
                  expected="${dir.input}/expected2.txt" actual="${dir.output}/actual2.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="basic-mapper-up-to-date">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="mapper-up-to-date"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>
    <mkdir dir="${dir.output}"/>
    <touch file="${dir.output}/output1.xml" datetime="01/01/2001 00:01:20 AM"/>

    <!-- input1: older -->
    <copy file="${dir.input}/input1.xml" tofile="${dir.output}/input1.xml"/>
    <touch file="${dir.output}/input1.xml" datetime="01/01/2001 00:01:10 AM"/>

    <!-- input2: newer -->
    <copy file="${dir.input}/input2.xml" tofile="${dir.output}/input2.xml"/>
    <touch file="${dir.output}/input2.xml" datetime="01/01/2001 00:01:30 AM"/>

    <chionographis srcdir="${dir.output}" includes="input*.xml" cache="no">
      <output destdir="${test.prefix}/output-${test.title}">
        <globmapper from="input*.xml" to="output*.xml"/>
      </output>
    </chionographis>

    <assertfilelastmodified name="${test.name}"
      file="${dir.output}/output1.xml" datetime="01/01/2001 00:01:20 AM"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="basic-not-up-to-date-by-depends-new">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="mapper-up-to-date-by-depends-new"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>
    <mkdir dir="${dir.output}"/>
    <touch file="${dir.output}/output.xml" datetime="01/01/2001 00:01:20 AM"/>

    <!-- input: older -->
    <copy file="${dir.input}/input1.xml" tofile="${dir.output}/input.xml"/>
    <touch file="${dir.output}/input.xml" datetime="01/01/2001 00:01:10 AM"/>

    <chionographis srcdir="${test.prefix}/output-${test.title}" includes="input.xml" cache="no">
      <!-- depends: absence means new -->
      <depends absent="new"><filelist dir="${dir.output}" files="ghost"/></depends>
      <output dest="${test.prefix}/output-${test.title}/output.xml"/>
    </chionographis>

    <xslt style="${basedir}/flatten.xsl"
            in="${dir.output}/output.xml" out="${dir.output}/actual.txt"/>
    <assertfileeq name="${test.name}"
      expected="${dir.input}/expected1.txt" actual="${dir.output}/actual.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="basic-up-to-date-by-depends-ignore">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="mapper-up-to-date-by-depends-ignore"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>
    <mkdir dir="${dir.output}"/>
    <touch file="${dir.output}/output1.xml" datetime="01/01/2001 00:01:20 AM"/>
    <touch file="${dir.output}/output2.xml" datetime="01/01/2001 00:01:15 AM"/>

    <!-- input1 and 2: older -->
    <copy file="${dir.input}/input1.xml" tofile="${dir.output}/input1.xml"/>
    <copy file="${dir.input}/input2.xml" tofile="${dir.output}/input2.xml"/>
    <touch file="${dir.output}/input1.xml" datetime="01/01/2001 00:01:10 AM"/>
    <touch file="${dir.output}/input2.xml" datetime="01/01/2001 00:01:00 AM"/>

    <chionographis srcdir="${test.prefix}/output-${test.title}" includes="input*.xml" cache="no">
      <depends absent="ignore"><fileset file="${dir.output}/ghost/ghost"/></depends>
      <output destdir="${test.prefix}/output-${test.title}">
        <globmapper from="input*.xml" to="output*.xml"/>
      </output>
    </chionographis>

    <assertfilelastmodified name="${test.name} - 1"
      file="${dir.output}/output1.xml" datetime="01/01/2001 00:01:20 AM"/>
    <assertfilelastmodified name="${test.name} - 2"
      file="${dir.output}/output2.xml" datetime="01/01/2001 00:01:15 AM"/>

    <delete dir="${dir.output}"/>
  </target>

  <depends id="depends1-basic-complex-depends">
    <depends basedir="basic/output-complex-depends">
      <filename name="x/input1.xml"/>
      <fileset dir="basic/output-complex-depends/x" includes="input1.dtd"/>
    </depends>
    <depends basedir="basic/output-complex-depends">
      <filename name="x/input2.xml"/>
      <fileset dir="basic/output-complex-depends/x" includes="input2.dtd"/>
    </depends>
    <depends basedir="basic/output-complex-depends">
      <filename name="x/input1.dtd"/>
      <fileset file="basic/output-complex-depends/default.dtd"/>
    </depends>
  </depends>

  <target name="basic-complex-depends">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="complex-depends"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input-${test.title}"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>
    <mkdir dir="${dir.output}"/>

    <copy todir="${dir.output}/x">
      <fileset dir="${dir.input}" includes="input*.xml input*.dtd"/>
    </copy>
    <copy file="${dir.input}/default.dtd" tofile="${dir.output}"/>
    <touch file="${dir.output}/x/input1.xml" datetime="01/01/2001 00:01:10 AM"/>
    <touch file="${dir.output}/x/input2.xml" datetime="01/01/2001 00:01:10 AM"/>
    <touch file="${dir.output}/x/input1.dtd" datetime="01/01/2001 00:01:00 AM"/>
    <touch file="${dir.output}/x/input2.dtd" datetime="01/01/2001 00:01:15 AM"/>
    <touch file="${dir.output}/default.dtd" datetime="01/01/2001 00:01:30 AM"/>

    <touch file="${dir.output}/x/output1.xml" datetime="01/01/2001 00:01:20 AM"/>
    <touch file="${dir.output}/x/output2.xml" datetime="01/01/2001 00:01:20 AM"/>

    <chionographis srcdir="${test.prefix}/output-${test.title}/x" includes="input*.xml" cache="no">
      <depends refid="depends1-basic-complex-depends"/>
      <output destdir="${test.prefix}/output-${test.title}/x">
        <globmapper from="input*.xml" to="output*.xml"/>
      </output>
    </chionographis>

    <xslt style="${basedir}/flatten.xsl"
            in="${dir.output}/x/output1.xml" out="${dir.output}/x/actual1.txt"/>
    <assertfileeq name="${test.name} - 1"
      expected="${dir.input}/expected1.txt" actual="${dir.output}/x/actual1.txt"/>
    <assertfilelastmodified name="${test.name} - 2"
      file="${dir.output}/x/output2.xml" datetime="01/01/2001 00:01:20 AM"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="basic-error-depends-fail">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="error-depends-fail"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <copy file="${dir.input}/input1.xml" tofile="${dir.output}/input1.xml"/>
    <touch file="${dir.output}/input1.xml" datetime="01/01/2001 00:01:10 AM"/>

    <!-- the output is up to date -->
    <touch file="${dir.output}/output1.xml" datetime="01/01/2001 00:01:20 AM"/>

    <chionographis srcdir="${dir.output}" includes="input1.xml" cache="no" failonerror="no">
      <depends absent="fail"><fileset file="${dir.input}/ghost"/></depends>
      <output dest="${dir.output}/output1.xml"/>
    </chionographis>

    <assertfilelastmodified name="${test.name} - 1"
      file="${dir.output}/output1.xml" datetime="01/01/2001 00:01:20 AM"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="basic-error-depends">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="error-depends"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis srcdir="${dir.input}" includes="input1.xml" cache="no" failonerror="no">
      <depends absent="fal"><fileset file="${dir.input}/ghost"/></depends>
      <output dest="${dir.output}/output1.xml"/>
    </chionographis>

    <assertfilenotexists name="${test.name}" file="${dir.output}/output1.xml"/>
  </target>

  <target name="basic-refer-content">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="refer-content"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input-${test.title}"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis basedir="basic" srcdir="input-${test.title}" includes="*.xml" cache="no">
      <output destdir="output-${test.title}"
                  refer="//processing-instruction('chionographis-output')[1]"/>
      <output destdir="output-${test.title}"
                  refer="//processing-instruction('chionographis-output')[1]">
        <globmapper from="output*.xml" to="output*.2.xml"/>
      </output>
    </chionographis>

    <xslt style="${basedir}/flatten.xsl"
            basedir="${dir.output}" destdir="${dir.output}" includes="*.xml">
      <globmapper from="output*.xml" to="actual*.txt"/>
    </xslt>
    <assertfileeq name="${test.name} - 1"
      expected="${dir.input}/expected.txt" actual="${dir.output}/actual.txt"/>
    <assertfileeq name="${test.name} - 1"
      expected="${dir.input}/expected.txt" actual="${dir.output}/actual.2.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="basic-force-output">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="force-output"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>
    <mkdir dir="${dir.output}"/>
    <touch file="${dir.output}/output1.xml" datetime="01/01/2001 00:01:20 AM"/>

    <!-- input1: older -->
    <copy file="${dir.input}/input1.xml" tofile="${dir.output}/input1.xml"/>
    <touch file="${dir.output}/input1.xml" datetime="01/01/2001 00:01:10 AM"/>

    <!-- input2: newer -->
    <copy file="${dir.input}/input2.xml" tofile="${dir.output}/input2.xml"/>
    <touch file="${dir.output}/input2.xml" datetime="01/01/2001 00:01:30 AM"/>

    <!-- output1 shall not be processed and output2 shall be processed -->
    <chionographis srcdir="${test.prefix}/output-${test.title}" includes="input*.xml" cache="no">
      <output destdir="${test.prefix}/output-${test.title}" force="yes">
        <globmapper from="input*.xml" to="output*.xml"/>
      </output>
    </chionographis>

    <xslt style="${basedir}/flatten.xsl"
          basedir="${dir.output}" destdir="${dir.output}" includes="*.xml">
      <globmapper from="output*.xml" to="actual*.txt"/>
    </xslt>
    <assertfileeq name="${test.name} - 1"
      actual="${dir.output}/actual1.txt" expected="${dir.input}/expected1.txt"/>
    <assertfileeq name="${test.name} - 2"
      actual="${dir.output}/actual2.txt" expected="${dir.input}/expected2.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="basic-force-task">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="force-task"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>
    <mkdir dir="${dir.output}"/>
    <touch file="${dir.output}/output1.xml" datetime="01/01/2001 00:01:20 AM"/>

    <!-- input1: older -->
    <copy file="${dir.input}/input1.xml" tofile="${dir.output}/input1.xml"/>
    <touch file="${dir.output}/input1.xml" datetime="01/01/2001 00:01:10 AM"/>

    <!-- input2: newer -->
    <copy file="${dir.input}/input2.xml" tofile="${dir.output}/input2.xml"/>
    <touch file="${dir.output}/input2.xml" datetime="01/01/2001 00:01:30 AM"/>

    <!-- output1 shall not be processed and output2 shall be processed -->
    <chionographis srcdir="${test.prefix}/output-${test.title}"
                   includes="input*.xml" force="yes" cache="no">
      <output destdir="${test.prefix}/output-${test.title}">
        <globmapper from="input*.xml" to="output*.xml"/>
      </output>
    </chionographis>

    <xslt style="${basedir}/flatten.xsl"
          basedir="${dir.output}" destdir="${dir.output}" includes="*.xml">
      <globmapper from="output*.xml" to="actual*.txt"/>
    </xslt>
    <assertfileeq name="${test.name} - 1"
      actual="${dir.output}/actual1.txt" expected="${dir.input}/expected1.txt"/>
    <assertfileeq name="${test.name} - 2"
      actual="${dir.output}/actual2.txt" expected="${dir.input}/expected2.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="basic-up-to-date-at-start">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="up-to-date-at-start"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input-${test.title}"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>
    <mkdir dir="${dir.output}"/>

    <touch file="${dir.output}/output1.xml" datetime="01/01/2001 00:01:20 AM"/>
    <touch file="${dir.output}/output2.xml" datetime="01/01/2001 00:01:30 AM"/>

    <copy todir="${dir.output}">
      <fileset dir="${dir.input}" includes="*.xml"/>
    </copy>
    <!-- input1: older -->
    <touch file="${dir.output}/input1.xml" datetime="01/01/2001 00:01:10 AM"/>
    <!-- input2: newer -->
    <touch file="${dir.output}/input2.xml" datetime="01/01/2001 00:01:40 AM"/>

    <chionographis basedir="${dir.output}" includes="input*.xml" cache="no">
      <output refer="/*/@num">
        <globmapper from="*" to="output*.xml"/>
      </output>
    </chionographis>

    <xslt style="${basedir}/flatten.xsl"
          in="${dir.output}/output2.xml" out="${dir.output}/actual2.txt"/>
    <assertfilelastmodified name="${test.name} - 1"
      file="${dir.output}/output1.xml" datetime="01/01/2001 00:01:20 AM"/>
    <assertfileeq name="${test.name}"
      expected="${dir.input}/expected2.txt" actual="${dir.output}/actual2.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="basic-not-up-to-date-at-start-by-depends">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="not-up-to-date-at-start-by-depends"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input-up-to-date-at-start"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>
    <mkdir dir="${dir.output}"/>

    <!-- output: older -->
    <touch file="${dir.output}/output.xml" datetime="01/01/2001 00:01:20 AM"/>
    <!-- dummy: newer -->
    <touch file="${dir.output}/dummy.txt" datetime="01/01/2001 00:01:40 AM"/>

    <copy todir="${dir.output}">
      <fileset dir="${dir.input}" includes="input2.xml"/>
    </copy>
    <touch file="${dir.output}/input.xml" datetime="01/01/2001 00:01:30 AM"/>

    <chionographis basedir="${dir.output}" includes="input2.xml" cache="no">
      <depends>
        <fileset file="${dir.output}/dummy.txt"/>
      </depends>
      <output dest="output.xml"/>
    </chionographis>

    <xslt style="${basedir}/flatten.xsl"
          in="${dir.output}/output.xml" out="${dir.output}/actual.txt"/>
    <assertfileeq name="${test.name}"
      expected="${dir.input}/expected2.txt" actual="${dir.output}/actual.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="basic-force-at-start">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="force-at-start"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input-up-to-date-at-start"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>
    <mkdir dir="${dir.output}"/>

    <touch file="${dir.output}/output1.xml" datetime="01/01/2001 00:01:20 AM"/>
    <touch file="${dir.output}/output2.xml" datetime="01/01/2001 00:01:30 AM"/>

    <copy todir="${dir.output}">
      <fileset dir="${dir.input}" includes="*.xml"/>
    </copy>
    <!-- input1 & 2: older -->
    <touch file="${dir.output}/input1.xml" datetime="01/01/2001 00:01:10 AM"/>
    <touch file="${dir.output}/input2.xml" datetime="01/01/2001 00:01:00 AM"/>

    <chionographis basedir="${dir.output}" includes="input*.xml" force="yes" cache="no">
      <output refer="/*/@num">
        <globmapper from="*" to="output*.xml"/>
      </output>
    </chionographis>

    <xslt style="${basedir}/flatten.xsl"
          basedir="${dir.output}" destdir="${dir.output}" includes="output*.xml">
      <globmapper from="output*.xml" to="actual*.txt"/>
    </xslt>
    <assertfileeq name="${test.name}"
      expected="${dir.input}/expected1.txt" actual="${dir.output}/actual1.txt"/>
    <assertfileeq name="${test.name}"
      expected="${dir.input}/expected2.txt" actual="${dir.output}/actual2.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="basic-meta">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="meta"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input-${test.title}"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis srcdir="${dir.input}" includes="*.xml" cache="no">
      <meta type="file-name"/>
      <meta type="file-title"/>
      <output dest="${dir.output}/output.xml"/>
    </chionographis>

    <xslt style="${basedir}/flatten.xsl"
          in="${dir.output}/output.xml" out="${dir.output}/actual.txt"/>
    <assertfileeq name="${test.name}"
      expected="${dir.input}/expected.txt" actual="${dir.output}/actual.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="basic-meta-uri">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="meta-uri"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input-meta"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis srcdir="${dir.input}" includes="*.xml" cache="no">
      <meta type="uri"/>
      <output dest="${dir.output}/output.xml"/>
    </chionographis>

    <xslt style="${basedir}/flatten.xsl"
          in="${dir.output}/output.xml" out="${dir.output}/actual.txt"/>

    <script language="javascript"><![CDATA[
      Paths = Java.type("java.nio.file.Paths");
      o = new java.io.FileWriter(
        new java.io.File(project.getProperty("dir.output"), "expected.txt"));
      o.write("[input:<chionographis-uri=");
      o.write(Paths.get(project.getProperty("dir.input"), "input.xml").toUri().toString());
      o.write(">[child:]]");
      o.close();
    ]]></script>

    <assertfileeq name="${test.name}"
      expected="${dir.output}/expected.txt" actual="${dir.output}/actual.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="basic-meta-title-no-extension">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="meta-title-no-extension"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input-meta"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>
    <copy file="${dir.input}/input.xml" tofile="${dir.output}/input"/>

    <chionographis srcdir="${dir.output}" includes="input" cache="no">
      <meta type="file-name"/>
      <meta type="file-title"/>
      <output dest="${dir.output}/output.xml"/>
    </chionographis>

    <xslt style="${basedir}/flatten.xsl"
          in="${dir.output}/output.xml" out="${dir.output}/actual.txt"/>
    <assertfileeq name="${test.name}"
      expected="${dir.input}/expected-no-extension.txt" actual="${dir.output}/actual.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="basic-error-meta-no-name-no-type">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="error-meta-no-name-no-type"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input-meta"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis srcdir="${dir.input}" includes="*.xml" cache="no" failonerror="no">
      <meta/>
      <output dest="${dir.output}/output.xml"/>
    </chionographis>

    <assertfilenotexists name="${test.name}" file="${dir.output}/output.xml"/>
  </target>

  <target name="basic-error-meta-no-type">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="error-meta-no-type"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input-meta"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis srcdir="${dir.input}" includes="*.xml" cache="no" failonerror="no">
      <meta name="xyz"/>
      <output dest="${dir.output}/output.xml"/>
    </chionographis>

    <assertfilenotexists name="${test.name}" file="${dir.output}/output.xml"/>
  </target>

  <target name="basic-error-meta-bad-type">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="error-meta-bad-type"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input-meta"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis srcdir="${dir.input}" includes="*.xml" cache="no" failonerror="no">
      <meta name="xyz" type="url"/>
      <output dest="${dir.output}/output.xml"/>
    </chionographis>

    <assertfilenotexists name="${test.name}" file="${dir.output}/output.xml"/>
  </target>

  <target name="basic-error-meta-empty-type">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="error-meta-empty-type"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input-meta"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis srcdir="${dir.input}" includes="*.xml" cache="no" failonerror="no">
      <meta name="xyz" type=""/>
      <output dest="${dir.output}/output.xml"/>
    </chionographis>

    <assertfilenotexists name="${test.name}" file="${dir.output}/output.xml"/>
  </target>

  <target name="basic-error-meta-bad-name">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="error-meta-bad-name"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input-meta"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis srcdir="${dir.input}" includes="*.xml" cache="no" failonerror="no">
      <meta name="xMl" type="file-name"/>
      <output dest="${dir.output}/output.xml"/>
    </chionographis>

    <assertfilenotexists name="${test.name}" file="${dir.output}/output.xml"/>
  </target>

  <target name="basic-error-meta-empty-name">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="error-meta-empty-name"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input-meta"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis srcdir="${dir.input}" includes="*.xml" cache="no" failonerror="no">
      <meta name="" type="file-name"/>
      <output dest="${dir.output}/output.xml"/>
    </chionographis>

    <assertfilenotexists name="${test.name}" file="${dir.output}/output.xml"/>
  </target>

  <target name="basic-meta-added-twice">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="meta-added-twice"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input-meta"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis srcdir="${dir.input}" includes="*.xml" cache="no">
      <meta name="meta" type="file-name"/>
      <meta name="meta" type="file-title"/>
      <output dest="${dir.output}/output.xml"/>
    </chionographis>

    <xslt style="${basedir}/flatten.xsl"
          in="${dir.output}/output.xml" out="${dir.output}/actual.txt"/>
    <assertfileeq name="${test.name}"
      expected="${dir.input}/expected-twice.txt" actual="${dir.output}/actual.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="basic-meta-refer-content">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="meta-refer-content"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input-meta"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis srcdir="${dir.input}" includes="*.xml" cache="no">
      <meta name="n" type="file-name"/>
      <meta name="t" type="file-title"/>
      <output destdir="${dir.output}" refer="/*/processing-instruction('t')">
        <globmapper from="in*" to="out*.xml"/>
      </output>
    </chionographis>

    <xslt style="${basedir}/flatten.xsl"
          in="${dir.output}/output.xml" out="${dir.output}/actual.txt"/>
    <assertfileeq name="${test.name}"
      expected="${dir.input}/expected-short.txt" actual="${dir.output}/actual.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="basic-error-namespace-no-prefix-no-uri">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="error-namespace-empty-prefix"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis srcdir="${dir.input}" includes="input1.xml" cache="no" failonerror="no">
      <namespace/>
      <output dest="${dir.output}/output1.xml"/>
    </chionographis>

    <assertfilenotexists name="${test.name}" file="${dir.output}/output1.xml"/>
  </target>

  <target name="basic-error-namespace-no-prefix">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="error-namespace-empty-prefix"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis srcdir="${dir.input}" includes="input1.xml" cache="no" failonerror="no">
      <namespace uri="http://furfurylic.net/ns"/>
      <output dest="${dir.output}/output1.xml"/>
    </chionographis>

    <assertfilenotexists name="${test.name}" file="${dir.output}/output1.xml"/>
  </target>

  <target name="basic-error-namespace-no-uri">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="error-namespace-empty-prefix"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis srcdir="${dir.input}" includes="input1.xml" cache="no" failonerror="no">
      <namespace prefix="xyz"/>
      <output dest="${dir.output}/output1.xml"/>
    </chionographis>

    <assertfilenotexists name="${test.name}" file="${dir.output}/output1.xml"/>
  </target>

  <target name="basic-error-namespace-bad-prefix">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="error-namespace-bad-prefix"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis srcdir="${dir.input}" includes="input1.xml" cache="no" failonerror="no">
      <namespace prefix="XMLN" uri="http://furfurylic.net/ns"/>
      <output dest="${dir.output}/output1.xml"/>
    </chionographis>

    <assertfilenotexists name="${test.name}" file="${dir.output}/output1.xml"/>
  </target>

  <target name="basic-error-namespace-empty-prefix">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="error-namespace-empty-prefix"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis srcdir="${dir.input}" includes="input1.xml" cache="no" failonerror="no">
      <namespace prefix="" uri="http://furfurylic.net/ns"/>
      <output dest="${dir.output}/output1.xml"/>
    </chionographis>

    <assertfilenotexists name="${test.name}" file="${dir.output}/output1.xml"/>
  </target>

  <target name="basic-error-namespace-added-twice">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="error-namespace-added-twice"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis srcdir="${dir.input}" includes="input1.xml" cache="no" failonerror="no">
      <namespace prefix="a" uri="http://furfurylic.net/ns"/>
      <namespace prefix="b" uri="http://furfurylic.net/ns"/>
      <namespace prefix="a" uri="http://furfurylic.net/ns"/>
      <output dest="${dir.output}/output1.xml"/>
    </chionographis>

    <assertfilenotexists name="${test.name}" file="${dir.output}/output1.xml"/>
  </target>

  <target name="basic-error-no-sinks">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="error-no-sinks"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis srcdir="${dir.input}" includes="*.xml" cache="no" failonerror="no"/>

    <assertfilenotexists name="${test.name}" file="${dir.output}"/>
  </target>

  <target name="basic-error-output-mapper-added-twice">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="error-output-mapper-added-twice"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis srcdir="${dir.input}" includes="*.xml" cache="no" failonerror="no">
      <output destdir="${dir.output}">
        <globmapper from="input*.xml" to="output*.xml"/>
        <globmapper from="input*.xml" to="output*_2.xml"/>
      </output>
    </chionographis>

    <assertfilenotexists name="${test.name}" file="${dir.output}"/>
  </target>

  <target name="basic-error-output-dest-and-mapper">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="error-output-dest-and-mapper"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis srcdir="${dir.input}" includes="*.xml" cache="no" failonerror="no">
      <output destdir="${dir.output}" dest="output1.xml">
        <globmapper from="input*.xml" to="output*.xml"/>
      </output>
    </chionographis>

    <assertfilenotexists name="${test.name}" file="${dir.output}"/>
  </target>

  <target name="basic-error-output-dest-and-refer">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="error-output-dest-and-refer"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis srcdir="${dir.input}" includes="input1.xml" cache="no" failonerror="no">
      <output destdir="${dir.output}" dest="output1.xml" refer="local-name(/*)"/>
    </chionographis>

    <assertfilenotexists name="${test.name}" file="${dir.output}"/>
  </target>

  <target name="basic-error-output-no-clue">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="error-output-no-clue"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis srcdir="${dir.input}" includes="input1.xml" cache="no" failonerror="no">
      <output destdir="${dir.output}"/>
    </chionographis>

    <assertfilenotexists name="${test.name}" file="${dir.output}"/>
  </target>

  <target name="basic-error-output-bad-refer">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="error-output-bad-refer"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis srcdir="${dir.input}" includes="input*.xml" cache="no" failonerror="no">
      <output destdir="${dir.output}" refer="loca-name(/*)">
        <globmapper from="input*.xml" to="output*.xml"/>
      </output>
    </chionographis>

    <assertfilenotexists name="${test.name}" file="${dir.output}"/>
  </target>

  <target name="basic-no-matching-input">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="no-matching-input"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis srcdir="${dir.input}" includes="input*.txt" cache="no">
      <output destdir="${dir.output}" refer="local-name(/*/*)">
        <globmapper from="input*.xml" to="output*.xml"/>
      </output>
    </chionographis>

    <assertfilenotexists name="${test.name}" file="${dir.output}"/>
  </target>

  <target name="basic-output-no-mapped">
    <property name="test.prefix" value="basic"/>
    <property name="test.title" value="error-output-no-mapped"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis srcdir="${dir.input}" includes="input*.xml" cache="no">
      <output destdir="${dir.output}" refer="local-name(/*/*)">
        <globmapper from="input*.xml" to="output*.xml"/>
      </output>
    </chionographis>

    <assertfilenotexists name="${test.name}" file="${dir.output}"/>
  </target>

  <target name="transform">
    <property name="test.prefix" value="transform"/>
    <property name="test.name" value="${test.prefix}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output"/>

    <delete dir="${dir.output}"/>

    <chionographis basedir="${test.prefix}" includes="input/input.xml" cache="no">
      <transform style="../flatten.xsl" cache="no">
        <output dest="output/actual.txt"/>
      </transform>
    </chionographis>

    <assertfileeq name="${test.name}"
      expected="${dir.input}/expected.txt" actual="${dir.output}/actual.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="transform-error-no-stylesheet-configured">
    <property name="test.prefix" value="transform"/>
    <property name="test.title" value="error-no-stylesheet-configured"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output"/>

    <delete dir="${dir.output}"/>

    <chionographis basedir="${dir.input}" includes="input.xml" cache="no">
      <transform cache="no">
        <output dest="${dir.output}/actual.txt"/>
      </transform>
    </chionographis>

    <assertfilenotexists name="${test.name}" file="${dir.output}/actual.txt"/>
  </target>

  <target name="transform-error-stylesheet">
    <property name="test.prefix" value="transform"/>
    <property name="test.title" value="error-stylesheet"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output"/>

    <delete dir="${dir.output}"/>

    <chionographis basedir="${dir.input}" includes="input.xml" cache="no" failonerror="no">
      <transform style="${dir.input}/not-exist.xsl" cache="no">
        <output dest="${dir.output}/actual.txt"/>
      </transform>
    </chionographis>

    <assertfilenotexists name="${test.name}" file="${dir.output}/actual.txt"/>
  </target>

  <target name="transform-params">
    <property name="test.prefix" value="transform"/>
    <property name="test.title" value="params"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <property name="param.p1" value="v1"/>
    <property name="param.p2" value="v2"/>

    <delete dir="${dir.output}"/>

    <chionographis basedir="${test.prefix}" includes="input/input.xml" cache="no">
      <transform style="input/flatten-nons.xsl" cache="no">
        <param name="p1" expand="yes">${param.p1}</param>
        <param name="p2">${param.p2}</param>
        <output dest="output-${test.title}/actual.txt"/>
      </transform>
    </chionographis>

    <assertfileeq name="${test.name}"
      expected="${dir.input}/expected-params.txt" actual="${dir.output}/actual.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="transform-params-ns">
    <property name="test.prefix" value="transform"/>
    <property name="test.title" value="params-ns"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <property name="param.p1" value="v1"/>

    <delete dir="${dir.output}"/>

    <chionographis basedir="${test.prefix}" includes="input/input.xml" cache="no">
      <namespace prefix="p1"
                 uri="http://www.furfurylic.net/chionographis/test/transform/ns/1"/>
      <namespace prefix="p2"
                 uri="http://www.furfurylic.net/chionographis/test/transform/ns/2"/>
      <transform style="input/flatten-ns.xsl" cache="no">
        <!-- becomes v0 -->
        <param name="p">v<![CDATA[0]]></param>
        <!-- expanded as ${param.p1} -->
        <param name="p1:p" expand="yes">${param.<![CDATA[p1}]]></param>
        <!-- $$ becomes $ not to be expanded -->
        <param name="{http://www.furfurylic.net/chionographis/test/transform/ns/2}p"
          expand="yes">$${param.p2}</param>
        <param name="q"/>
        <output dest="output-${test.title}/actual.txt"/>
      </transform>
    </chionographis>

    <assertfileeq name="${test.name}"
      expected="${dir.input}/expected-params.txt" actual="${dir.output}/actual.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="transform-assoc">
    <property name="test.prefix" value="transform"/>
    <property name="test.title" value="assoc"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input-${test.title}"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>
    <mkdir dir="${dir.output}"/>
    <mkdir dir="${dir.output}/styles"/>

    <copy file="flatten.xsl" todir="${dir.output}/styles"/>
    <copy file="${dir.input}/flatten2.xsl" todir="${dir.output}/styles"/>
    <copy todir="${dir.output}">
      <fileset dir="${dir.input}" includes="input*.xml"/>
    </copy>
    <copy file="${dir.output}/input2a.xml" tofile="${dir.output}/input2b.xml"/>

    <touch file="${dir.output}/actual1.txt"  datetime="01/01/2001 00:01:10 AM"/> <!-- older -->
    <touch file="${dir.output}/actual2a.txt" datetime="01/01/2001 00:01:10 AM"/> <!-- older -->
    <touch file="${dir.output}/actual2b.txt" datetime="01/01/2001 00:01:30 AM"/> <!-- newer -->
    <touch file="${dir.output}/styles/flatten.xsl"  datetime="01/01/2001 00:01:20 AM"/>
    <touch file="${dir.output}/styles/flatten2.xsl" datetime="01/01/2001 00:01:20 AM"/>
    <touch file="${dir.output}/input1.xml"  datetime="01/01/2001 00:01:20 AM"/>
    <touch file="${dir.output}/input2a.xml" datetime="01/01/2001 00:01:20 AM"/>
    <touch file="${dir.output}/input2b.xml" datetime="01/01/2001 00:01:20 AM"/>

    <!-- input1.xml is associated to flatten.xsl,
         and input2a.xml and input2b.xml is to flatten2.xsl with title 'a' -->

    <chionographis basedir="${dir.output}" includes="input*.xml" cache="no">
      <transform cache="no">
        <assoc title="a" charset="UTF-8"/>
        <param name="p">__</param>
        <output destdir="${dir.output}">
          <globmapper from="input*.xml" to="actual*.txt"/>
        </output>
      </transform>
    </chionographis>

    <assertfileeq name="${test.name} - 1"
      expected="${dir.input}/expected1.txt" actual="${dir.output}/actual1.txt"/>
    <assertfileeq name="${test.name} - 2a"
      expected="${dir.input}/expected2a.txt" actual="${dir.output}/actual2a.txt"/>
    <assertfilelastmodified name="${test.name} - 2b"
      file="${dir.output}/actual2b.txt" datetime="01/01/2001 00:01:30 AM"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="transform-error-params-bad-prefix">
    <property name="test.prefix" value="transform"/>
    <property name="test.title" value="error-params-bad-prefix"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis srcdir="${dir.input}" includes="input.xml" cache="no" failonerror="no">
      <namespace prefix="p1"
                 uri="http://www.furfurylic.net/chionographis/test/transform/ns/1"/>
      <namespace prefix="p2"
                 uri="http://www.furfurylic.net/chionographis/test/transform/ns/1"/>
      <transform style="input/flatten-ns.xsl" cache="no">
        <param name="p">v0</param>
        <param name="p1:p">v1</param>
        <param name="P2:p">${param.p2}</param> <!-- unbound prefix -->
        <output dest="${dir.output}/actual.txt"/>
      </transform>
    </chionographis>

    <assertfilenotexists name="${test.name}" file="${dir.output}/actual.txt"/>
  </target>

  <target name="transform-error-params-no-name-no-value">
    <property name="test.prefix" value="transform"/>
    <property name="test.title" value="error-params-no-name-no-value"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis basedir="${dir.input}" includes="input.xml" cache="no" failonerror="no">
      <transform style="flatten-nons.xsl" cache="no">
        <param/>
        <output dest="${dir.output}/actual.txt"/>
      </transform>
    </chionographis>

    <assertfilenotexists name="${test.name}" file="${dir.output}/actual.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="transform-error-params-no-name">
    <property name="test.prefix" value="transform"/>
    <property name="test.title" value="error-params-no-name"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <property name="param.p1" value="v1"/>

    <delete dir="${dir.output}"/>

    <chionographis basedir="${dir.input}" includes="input.xml" cache="no" failonerror="no">
      <transform style="flatten-nons.xsl" cache="no">
        <param expand="yes">${param.p1}</param>
        <output dest="${dir.output}/actual.txt"/>
      </transform>
    </chionographis>

    <assertfilenotexists name="${test.name}" file="${dir.output}/actual.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="transform-error-params-empty-name">
    <property name="test.prefix" value="transform"/>
    <property name="test.title" value="error-params-no-name"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <property name="param.p1" value="v1"/>

    <delete dir="${dir.output}"/>

    <chionographis basedir="${dir.input}" includes="input.xml" cache="no" failonerror="no">
      <transform style="flatten-nons.xsl" cache="no">
        <param name="" expand="yes">${param.p1}</param>
        <output dest="${dir.output}/actual.txt"/>
      </transform>
    </chionographis>

    <assertfilenotexists name="${test.name}" file="${dir.output}/actual.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="transform-error-params-added-twice">
    <property name="test.prefix" value="transform"/>
    <property name="test.title" value="error-params-added-twice"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <property name="param.p1" value="v1"/>
    <property name="param.p2" value="v2"/>

    <delete dir="${dir.output}"/>

    <chionographis basedir="${dir.input}" includes="input.xml" cache="no" failonerror="no">
      <transform style="flatten-nons.xsl" cache="no">
        <param name="p1" expand="yes">${param.p1}</param>
        <param name="p2">${param.p2}</param>
        <param name="p1">v11</param>
        <output dest="${dir.output}/actual.txt"/>
      </transform>
    </chionographis>

    <assertfilenotexists name="${test.name}" file="${dir.output}/actual.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="transform-error-params-value-format">
    <property name="test.prefix" value="transform"/>
    <property name="test.title" value="error-params-no-value"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <property name="param.p1" value="v1"/>

    <delete dir="${dir.output}"/>

    <chionographis basedir="${dir.input}" includes="input.xml" cache="no" failonerror="no">
      <transform style="flatten-nons.xsl" cache="no">
        <param name="p1" expand="yes">${param.p1</param> <!-- lacking the last "}" -->
        <output dest="${dir.output}/actual.txt"/>
      </transform>
    </chionographis>

    <assertfilenotexists name="${test.name}" file="${dir.output}/actual.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="transform-error-style-and-assoc">
    <property name="test.prefix" value="transform"/>
    <property name="test.title" value="error-style-and-assoc"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input-assoc"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>
    <mkdir dir="${dir.output}"/>

    <chionographis basedir="${dir.input}" includes="input2a.xml" cache="no" failonerror="no">
      <transform style="flatten2.xsl" cache="no">
        <assoc media="screen" title="a" charset="UTF-8"/>
        <output dest="${dir.output}/actual2a.txt"/>
      </transform>
    </chionographis>

    <assertfilenotexists name="${test.name}" file="${dir.output}/actual2a.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="transform-refer-content">
    <property name="test.prefix" value="transform"/>
    <property name="test.title" value="refer-content"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis includes="${test.prefix}/input/*-${test.title}.xml" cache="no">
      <transform style="flatten.xsl" cache="no">
        <output destdir="${test.prefix}/output-${test.title}"
                refer="/*/processing-instruction('chionographis-output')[1]"/>
      </transform>
    </chionographis>

    <assertfileeq name="${test.name}"
      expected="${dir.input}/expected-${test.title}.txt" actual="${dir.output}/actual.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="transform-not-up-to-date">
    <property name="test.prefix" value="transform"/>
    <property name="test.title" value="not-up-to-date"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>
    <mkdir dir="${dir.output}"/>

    <touch file="${dir.output}/actual.txt" datetime="01/01/2001 00:01:10 AM"/>

    <!-- input: older -->
    <copy file="transform/input/input.xml" todir="${dir.output}"/>
    <touch file="${dir.output}/input.xml" datetime="01/01/2001 00:01:00 AM"/>

    <!-- style: newer -->
    <copy file="flatten.xsl" todir="${dir.output}"/>
    <touch file="${dir.output}/flatten.xsl" datetime="01/01/2001 00:01:20 AM"/>

    <!-- Shall be processed -->
    <chionographis basedir="${test.prefix}" includes="input/input.xml" cache="no">
      <transform style="output-${test.title}/flatten.xsl" cache="no">
        <output dest="output-${test.title}/actual.txt"/>
      </transform>
    </chionographis>

    <assertfileeq name="${test.name}"
      expected="transform/input/expected.txt" actual="${dir.output}/actual.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="transform-not-up-to-date-at-start">
    <property name="test.prefix" value="transform"/>
    <property name="test.title" value="not-up-to-date-at-start"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>
    <mkdir dir="${dir.output}"/>

    <touch file="${dir.output}/actual1.txt" datetime="01/01/2001 00:01:10 AM"/>

    <!-- input: newer -->
    <copy file="transform/input/input.xml" todir="${dir.output}"/>
    <touch file="${dir.output}/input.xml" datetime="01/01/2001 00:01:20 AM"/>

    <!-- style: older -->
    <copy file="flatten.xsl" todir="${dir.output}"/>
    <touch file="${dir.output}/flatten.xsl" datetime="01/01/2001 00:00:45 AM"/>

    <!-- Shall be processed -->
    <chionographis basedir="${test.prefix}" includes="input/input.xml" cache="no">
      <transform style="output-${test.title}/flatten.xsl" cache="no">
        <output destdir="${dir.output}" refer="local-name(/*)">
          <globmapper from="input*" to="actual*.txt"/>
        </output>
      </transform>
    </chionographis>

    <assertfileeq name="${test.name}"
      expected="transform/input/expected.txt" actual="${dir.output}/actual1.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="transform-not-up-to-date-by-depends">
    <property name="test.prefix" value="transform"/>
    <property name="test.title" value="not-up-to-date-by-depends"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>
    <mkdir dir="${dir.output}"/>

    <touch file="${dir.output}/actual.txt" datetime="01/01/2001 00:01:10 AM"/>

    <!-- dummy for "depends": newer -->
    <touch file="${dir.output}/dummy.xml" datetime="01/01/2001 00:01:15 AM"/>

    <!-- input: older -->
    <copy file="transform/input/input.xml" todir="${dir.output}"/>
    <touch file="${dir.output}/input.xml" datetime="01/01/2001 00:01:00 AM"/>

    <!-- style: older -->
    <copy file="flatten.xsl" todir="${dir.output}"/>
    <touch file="${dir.output}/flatten.xsl" datetime="01/01/2001 00:01:05 AM"/>

    <!-- Shall be processed -->
    <chionographis basedir="${test.prefix}" includes="input/input.xml" cache="no">
      <transform style="output-${test.title}/flatten.xsl" cache="no">
        <depends><fileset file="${dir.output}/dummy.xml"/></depends>
        <output dest="output-${test.title}/actual.txt"/>
      </transform>
    </chionographis>

    <assertfileeq name="${test.name}"
      expected="transform/input/expected.txt" actual="${dir.output}/actual.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="transform-not-up-to-date-by-depends-new">
    <property name="test.prefix" value="transform"/>
    <property name="test.title" value="not-up-to-date-by-depends-new"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>
    <mkdir dir="${dir.output}"/>

    <touch file="${dir.output}/actual.txt" datetime="01/01/2001 00:01:10 AM"/>

    <!-- input: older -->
    <copy file="transform/input/input.xml" todir="${dir.output}"/>
    <touch file="${dir.output}/input.xml" datetime="01/01/2001 00:01:00 AM"/>

    <!-- style: older -->
    <copy file="flatten.xsl" todir="${dir.output}"/>
    <touch file="${dir.output}/flatten.xsl" datetime="01/01/2001 00:01:05 AM"/>

    <!-- Shall be processed -->
    <chionographis basedir="${test.prefix}" includes="input/input.xml" cache="no">
      <transform style="output-${test.title}/flatten.xsl" cache="no">
        <depends absent="new"><fileset file="${dir.output}/dummy.xml"/></depends>
        <output dest="output-${test.title}/actual.txt"/>
      </transform>
    </chionographis>

    <assertfileeq name="${test.name}"
      expected="transform/input/expected.txt" actual="${dir.output}/actual.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="transform-force">
    <property name="test.prefix" value="transform"/>
    <property name="test.title" value="force"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>
    <mkdir dir="${dir.output}"/>

    <touch file="${dir.output}/actual.txt" datetime="01/01/2001 00:01:10 AM"/>

    <!-- input: older -->
    <copy file="transform/input/input.xml" todir="${dir.output}"/>
    <touch file="${dir.output}/input.xml" datetime="01/01/2001 00:01:00 AM"/>

    <!-- style: older -->
    <copy file="flatten.xsl" todir="${dir.output}"/>
    <touch file="${dir.output}/flatten.xsl" datetime="01/01/2001 00:00:50 AM"/>

    <!-- Shall be processed -->
    <chionographis basedir="${test.prefix}" includes="input/input.xml" cache="no">
      <transform style="${dir.output}/flatten.xsl" force="yes" cache="no">
        <output dest="output-${test.title}/actual.txt"/>
      </transform>
    </chionographis>

    <assertfileeq name="${test.name}"
      expected="${dir.input}/expected.txt" actual="${dir.output}/actual.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="all">
    <property name="test.prefix" value="all"/>
    <property name="test.name" value="${test.prefix}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output"/>

    <delete dir="${dir.output}"/>

    <chionographis basedir="${test.prefix}" includes="input/*.xml" cache="no">
      <all root="q">
        <output dest="output/output.xml"/>
      </all>
    </chionographis>

    <xslt style="${basedir}/flatten.xsl"
          in="${dir.output}/output.xml" out="${dir.output}/actual.txt"/>
    <assertfileeq2 name="${test.name}"
      expected1="${dir.input}/expected-a.txt" expected2="${dir.input}/expected-b.txt"
      actual="${dir.output}/actual.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="all-up-to-date">
    <property name="test.prefix" value="all"/>
    <property name="test.title" value="up-to-date"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>
    <mkdir dir="${dir.output}"/>

    <touch file="${dir.output}/output.xml" datetime="01/01/2001 00:01:20 AM"/>

    <!-- input1 and 2: older -->
    <copy todir="${dir.output}">
      <fileset dir="all/input" includes="*.xml"/>
    </copy>
    <touch file="${dir.output}/input1.xml" datetime="01/01/2001 00:01:10 AM"/>
    <touch file="${dir.output}/input2.xml" datetime="01/01/2001 00:01:00 AM"/>

    <!-- Shall not be processed -->
    <chionographis basedir="${test.prefix}" includes="output-${test.title}/input*.xml" cache="no">
      <all root="q">
        <output dest="output-${test.title}/output.xml"/>
      </all>
    </chionographis>

    <assertfilelastmodified name="${test.name}"
      file="${dir.output}/output.xml" datetime="01/01/2001 00:01:20 AM"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="all-up-to-date-late">
    <property name="test.prefix" value="all"/>
    <property name="test.title" value="up-to-date-late"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>
    <mkdir dir="${dir.output}"/>

    <touch file="${dir.output}/q.xml" datetime="01/01/2001 00:01:20 AM"/>

    <!-- input1 and 2: older -->
    <copy todir="${dir.output}">
      <fileset dir="all/input" includes="*.xml"/>
    </copy>
    <touch file="${dir.output}/input1.xml" datetime="01/01/2001 00:01:10 AM"/>
    <touch file="${dir.output}/input2.xml" datetime="01/01/2001 00:01:00 AM"/>

    <!-- Shall not be processed (decided later) -->
    <chionographis basedir="${test.prefix}" includes="output-${test.title}/input*.xml" cache="no">
      <all root="q">
        <output destdir="output-${test.title}" refer="local-name(/*)">
          <globmapper from="*" to="*.xml"/>
        </output>
      </all>
    </chionographis>

    <assertfilelastmodified name="${test.name}"
      file="${dir.output}/q.xml" datetime="01/01/2001 00:01:20 AM"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="all-not-up-to-date-late">
    <property name="test.prefix" value="all"/>
    <property name="test.title" value="not-up-to-date-late"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>
    <mkdir dir="${dir.output}"/>

    <touch file="${dir.output}/q.xml" datetime="01/01/2001 00:01:20 AM"/>

    <copy todir="${dir.output}">
      <fileset dir="all/input" includes="*.xml"/>
    </copy>

    <!-- input1: older -->
    <touch file="${dir.output}/input1.xml" datetime="01/01/2001 00:01:10 AM"/>

    <!-- input2: newer -->
    <touch file="${dir.output}/input2.xml" datetime="01/01/2001 00:01:30 AM"/>

    <!-- Shall be processed -->
    <chionographis basedir="${test.prefix}" includes="output-${test.title}/input*.xml" cache="no">
      <all root="q">
        <output destdir="output-${test.title}" refer="local-name(/*)">
          <globmapper from="*" to="*.xml"/>
        </output>
      </all>
    </chionographis>

    <xslt style="${basedir}/flatten.xsl" in="${dir.output}/q.xml" out="${dir.output}/actual.txt"/>
    <assertfileeq2 name="${test.name}"
      expected1="${dir.input}/expected-a.txt" expected2="${dir.input}/expected-b.txt"
      actual="${dir.output}/actual.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="all-ns">
    <property name="test.prefix" value="all"/>
    <property name="test.title" value="ns"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input-${test.title}"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis basedir="${test.prefix}" includes="input-${test.title}/*.xml" cache="no">
      <namespace prefix="all" uri="http://www.furfurylic.net/chionographis/test/all/ns/task1"/>
      <all root="all:p">
        <all root="{http://www.furfurylic.net/chionographis/test/all/ns/task2}q">
          <output dest="output-${test.title}/output.xml"/>
        </all>
      </all>
    </chionographis>

    <xslt style="${basedir}/flatten.xsl"
          in="${dir.output}/output.xml" out="${dir.output}/actual.txt"/>
    <assertfileeq name="${test.name}"
      expected="${dir.input}/expected.txt" actual="${dir.output}/actual.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="all-error-bad-prefix">
    <property name="test.prefix" value="all"/>
    <property name="test.title" value="error-bad-prefix"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input-ns"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis srcdir="${dir.input}" includes="*.xml" cache="no" failonerror="no">
      <namespace prefix="all" uri="http://www.furfurylic.net/chionographis/test/all/ns/task1"/>
      <all root="ALL:p"> <!-- unbound prefix -->
        <output dest="${dir.output}/output.xml"/>
      </all>
    </chionographis>

    <assertfilenotexists name="${test.name}" file="${dir.output}/output.txt"/>
  </target>

  <target name="all-force">
    <property name="test.prefix" value="all"/>
    <property name="test.title" value="force"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>
    <mkdir dir="${dir.output}"/>

    <touch file="${dir.output}/output.xml" datetime="01/01/2001 00:01:20 AM"/>

    <!-- input1 and 2: older -->
    <copy todir="${dir.output}">
      <fileset dir="all/input" includes="*.xml"/>
    </copy>
    <touch file="${dir.output}/input1.xml" datetime="01/01/2001 00:01:10 AM"/>
    <touch file="${dir.output}/input2.xml" datetime="01/01/2001 00:01:00 AM"/>

    <!-- Shall BE processed -->
    <chionographis basedir="${test.prefix}" includes="output-${test.title}/input*.xml" cache="no">

      <all root="q" force="yes">
        <output dest="output-${test.title}/output.xml"/>
      </all>
    </chionographis>

    <xslt style="${basedir}/flatten.xsl"
          in="${dir.output}/output.xml" out="${dir.output}/actual.txt"/>
    <assertfileeq2 name="${test.name}"
      expected1="${dir.input}/expected-a.txt" expected2="${dir.input}/expected-b.txt"
      actual="${dir.output}/actual.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="snip-1">
    <property name="test.prefix" value="snip"/>
    <property name="test.title" value="1"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input${test.title}"/>
    <property name="dir.output" location="${test.prefix}/output${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis srcdir="${test.prefix}/input${test.title}" includes="*.xml" cache="no">
      <snip select="//b">
        <output destdir="${test.prefix}/output${test.title}"
                refer="//processing-instruction('chionographis-output')"/>
      </snip>
    </chionographis>

    <xslt style="${basedir}/flatten.xsl"
          basedir="${dir.output}" destdir="${dir.output}" includes="*.xml">
      <globmapper from="output*.xml" to="actual*.txt"/>
    </xslt>
    <assertfileeq name="${test.name} - 1a"
      expected="${dir.input}/expected1a.txt" actual="${dir.output}/actual1a.txt"/>
    <assertfileeq name="${test.name} - 1b"
      expected="${dir.input}/expected1b.txt" actual="${dir.output}/actual1b.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="snip-2">
    <property name="test.prefix" value="snip"/>
    <property name="test.title" value="2"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input${test.title}"/>
    <property name="dir.output" location="${test.prefix}/output${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis srcdir="${test.prefix}/input${test.title}" includes="*.xml" cache="no">
      <snip select="a/b">
        <output destdir="${test.prefix}/output${test.title}"
                refer="//processing-instruction('chionographis-output')"/>
      </snip>
    </chionographis>

    <xslt style="${basedir}/flatten.xsl"
          basedir="${dir.output}" destdir="${dir.output}" includes="*.xml">
      <globmapper from="output*.xml" to="actual*.txt"/>
    </xslt>
    <assertfileeq name="${test.name} - 1a"
      expected="${dir.input}/expected1a.txt" actual="${dir.output}/actual1a.txt"/>
    <assertfileeq name="${test.name} - 1b"
      expected="${dir.input}/expected1b.txt" actual="${dir.output}/actual1b.txt"/>
    <assertfileeq name="${test.name} - 2a"
      expected="${dir.input}/expected2a.txt" actual="${dir.output}/actual2a.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="snip-ns">
    <property name="test.prefix" value="snip"/>
    <property name="test.title" value="ns"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input-${test.title}"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis srcdir="${test.prefix}/input-${test.title}" includes="*.xml" cache="no">
      <namespace prefix="q" uri="http://www.furfurylic.net/chionographis/test"/>
      <snip select="//q:a[2]">
        <output destdir="${test.prefix}/output-${test.title}"
                refer="//processing-instruction('chionographis-output')"/>
      </snip>
    </chionographis>

    <xslt style="${basedir}/flatten.xsl"
          in="${dir.output}/output2.xml" out="${dir.output}/actual2.txt"/>
    <assertfileeq name="${test.name}"
      expected="${dir.input}/expected2.txt" actual="${dir.output}/actual2.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="snip-error-bad-xpath">
    <property name="test.prefix" value="snip"/>
    <property name="test.title" value="error-bad-xpath"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input1"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis srcdir="${dir.input}" includes="*.xml" cache="no" failonerror="no">
      <snip select="/descendent-or-self::b"> <!-- Bad axis: descendant-or-self, by rights -->
        <output destdir="${dir.output}"
                refer="//processing-instruction('chionographis-output')"/>
      </snip>
    </chionographis>

    <assertfilenotexists name="${test.name}" file="${dir.output}"/>
  </target>

  <target name="crossing-cache">
    <property name="test.prefix" value="crossing"/>
    <property name="test.title" value="cache"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input-${test.title}"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis basedir="${test.prefix}/input-${test.title}" includes="input.xml" verbose="yes">
      <meta type="file-title"/>
      <transform style="style1.xsl">
        <output dest="../output-${test.title}/actual1.txt"/>
      </transform>
      <transform style="style2.xsl">
        <output dest="../output-${test.title}/actual2.txt"/>
      </transform>
    </chionographis>

    <assertfileeq name="${test.name} - 1"
      expected="${dir.input}/expected1.txt" actual="${dir.output}/actual1.txt"/>
    <assertfileeq name="${test.name} - 2"
      expected="${dir.input}/expected2.txt" actual="${dir.output}/actual2.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="crossing-cache-refer-content">
    <property name="test.prefix" value="crossing"/>
    <property name="test.title" value="cache-refer-content"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input-cache"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis basedir="${dir.input}" includes="input.xml" verbose="yes">
      <meta type="file-title"/>
      <output destdir="../output-${test.title}" refer="count(/*/*)">
        <globmapper from="*" to="output*.xml"/>
      </output>
      <transform style="style2.xsl">
        <output dest="../output-${test.title}/actual2.txt"/>
      </transform>
    </chionographis>

    <xslt style="${basedir}/flatten.xsl"
          basedir="${dir.output}" destdir="${dir.output}" includes="*.xml">
      <globmapper from="output*.xml" to="actual*.txt"/>
    </xslt>
    <assertfileeq name="${test.name} - 0"
      expected="${dir.input}/expected0.txt" actual="${dir.output}/actual0.txt"/>
    <assertfileeq name="${test.name} - 2"
      expected="${dir.input}/expected2.txt" actual="${dir.output}/actual2.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="crossing-timid">
    <property name="test.prefix" value="crossing"/>
    <property name="test.title" value="timid"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input-${test.title}"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>
    <mkdir dir="${dir.output}"/>

    <copy file="${dir.input}/input.xml" tofile="${dir.output}/input1.xml"/>
    <copy file="${dir.input}/input.xml" tofile="${dir.output}/input2.xml"/>
    <copy file="${dir.input}/input.xml" tofile="${dir.output}/input3.xml"/>
    <copy file="${dir.input}/input.xml" tofile="${dir.output}/input4.xml"/>
    <copy todir="${dir.output}">
      <fileset dir="${dir.input}" includes="placeholder*.txt"/>
      <mapper type="glob" from="placeholder*.txt" to="actual*.txt"/>
    </copy>
    <touch file="${dir.output}/input1.xml" datetime="01/01/2001 00:01:10 AM"/>  <!-- newer -->
    <touch file="${dir.output}/input2.xml" datetime="01/01/2001 00:01:10 AM"/>  <!-- newer -->
    <touch file="${dir.output}/input3.xml" datetime="01/01/2001 00:01:10 AM"/>  <!-- newer -->
    <touch file="${dir.output}/actual1.txt" datetime="01/01/2001 00:01:00 AM"/> <!-- older -->
    <touch file="${dir.output}/actual2.txt" datetime="01/01/2001 00:01:00 AM"/> <!-- older -->
    <touch file="${dir.output}/actual3.txt" datetime="01/01/2001 00:01:00 AM"/> <!-- older -->

    <chionographis srcdir="${dir.output}" includes="input*.xml" cache="no">
      <transform style="flatten.xsl" cache="no">
        <output destdir="${dir.output}" timid="yes">
          <globmapper from="input*.xml" to="actual*.txt"/>
        </output>
      </transform>
    </chionographis>

    <!-- 1: identical: not touched -->
    <assertfilelastmodified name="${test.name} - 1"
      file="${dir.output}/actual1.txt" datetime="01/01/2001 00:01:00 AM"/>
    <!-- 2: equal length and different content: touched -->
    <assertfileeq name="${test.name} - 2"
      expected="${dir.input}/placeholder1.txt" actual="${dir.output}/actual2.txt"/>
    <!-- 3: different length: touched -->
    <assertfileeq name="${test.name} - 3"
      expected="${dir.input}/placeholder1.txt" actual="${dir.output}/actual3.txt"/>
    <!-- 4: missing in destination: touched -->
    <assertfileeq name="${test.name} - 4"
      expected="${dir.input}/placeholder1.txt" actual="${dir.output}/actual4.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="crossing-parallel-sinks">
    <property name="test.prefix" value="crossing"/>
    <property name="test.title" value="parallel-sinks"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input-${test.title}"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis basedir="${test.prefix}" srcdir="input-${test.title}"
                   includes="*.xml" cache="no">
      <!-- Original sources are: input1.xml and input2.xml.
           The latter contains document element's sibling. -->
      <all root="p">
        <output dest="output-${test.title}/output-p.xml"/>
      </all>
      <output destdir="${dir.output}">
        <globmapper from="in*.xml" to="out*.xml"/>
      </output>
      <all root="q">
        <output dest="output-${test.title}/output-q.xml"/>
      </all>
    </chionographis>

    <xslt style="${basedir}/flatten.xsl"
          basedir="${dir.output}" destdir="${dir.output}" includes="*.xml">
      <globmapper from="output*.xml" to="actual*.txt"/>
    </xslt>
    <assertfileeq2 name="${test.name} - all-p"
      expected1="${dir.input}/expected-p-a.txt" expected2="${dir.input}/expected-p-b.txt"
      actual="${dir.output}/actual-p.txt"/>
    <assertfileeq2 name="${test.name} - all-q"
      expected1="${dir.input}/expected-q-a.txt" expected2="${dir.input}/expected-q-b.txt"
      actual="${dir.output}/actual-q.txt"/>
    <assertfileeq name="${test.name} - output1"
      expected="${dir.input}/expected1.txt" actual="${dir.output}/actual1.txt"/>
    <assertfileeq name="${test.name} - output2"
      expected="${dir.input}/expected2.txt" actual="${dir.output}/actual2.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="crossing-abort-sources">
    <property name="test.prefix" value="crossing"/>
    <property name="test.title" value="abort-sources"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input-${test.title}"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>
    <mkdir dir="${dir.output}/1"/>
    <mkdir dir="${dir.output}/3"/>

    <chionographis basedir="${test.prefix}" srcdir="input-${test.title}"
                   includes="input*.xml" cache="no">
      <!-- Original sources are: input1.xml, input2.xml, input3.xml.
               input2.xml's output shall fail due to absence of the parent directory.  -->
      <transform style="../flatten.xsl">
        <output destdir="output-${test.title}" mkdirs="no">
          <regexpmapper from="^input([0-9])\.xml$$" to="\1/output.txt"/>
        </output>
      </transform>
    </chionographis>

    <assertfileeq name="${test.name} - 1"
      expected="${dir.input}/expected1.txt" actual="${dir.output}/1/output.txt"/>
    <assertfileeq name="${test.name} - 3"
      expected="${dir.input}/expected3.txt" actual="${dir.output}/3/output.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="crossing-abort-sinks-dom">
    <property name="test.prefix" value="crossing"/>
    <property name="test.title" value="abort-sinks-dom"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input-abort-sinks"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis basedir="${test.prefix}" srcdir="${dir.input}" includes="input.xml" cache="no">
      <!-- a: this will fail due to "makedirs='no'" -->
      <transform style="../flatten.xsl">
        <output dest="output-${test.title}/a/output.txt" mkdirs="no"/>
      </transform>
      <!-- b, c, and d below shall be aborted in collateral of a -->
      <!-- b: DOM-based multiple sink driver -->
      <transform style="../flatten.xsl">
        <output destdir="${dir.output}" refer="local-name(/*/@*)">
          <globmapper from="*" to="*1/output.txt"/>
        </output>
        <output destdir="${dir.output}" refer="local-name(/*/@*)">
          <globmapper from="*" to="*2/output.txt"/>
        </output>
      </transform>
      <!-- c: SAX-based multiple sink driver -->
      <transform style="../flatten.xsl">
        <output dest="${dir.output}/c1/output.txt"/>
        <output dest="${dir.output}/c2/output.txt"/>
      </transform>
      <!-- d: single sink driver -->
      <transform style="../flatten.xsl">
        <output dest="${dir.output}/d/output.txt"/>
      </transform>
    </chionographis>

    <assertfilenotexists name="${test.name} - b1" file="${dir.output}/b1/output.txt"/>
    <assertfilenotexists name="${test.name} - b2" file="${dir.output}/b2/output.txt"/>
    <assertfilenotexists name="${test.name} - c1" file="${dir.output}/c1/output.txt"/>
    <assertfilenotexists name="${test.name} - c2" file="${dir.output}/c2/output.txt"/>
    <assertfilenotexists name="${test.name} - d" file="${dir.output}/d/output.txt"/>

    <delete dir="${dir.output}"/>
  </target>

  <target name="crossing-abort-sinks-sax">
    <property name="test.prefix" value="crossing"/>
    <property name="test.title" value="abort-sinks-sax"/>
    <property name="test.name" value="${test.prefix}-${test.title}"/>
    <property name="dir.input" location="${test.prefix}/input-abort-sinks"/>
    <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

    <delete dir="${dir.output}"/>

    <chionographis basedir="${test.prefix}" srcdir="${dir.input}" includes="input.xml" cache="no">
      <!-- a: this will fail due to "makedirs='no'" -->
      <transform style="../flatten.xsl">
        <output dest="${dir.output}/a/output.txt" mkdirs="no"/>
      </transform>
      <!-- c below shall be aborted in collateral of a -->
      <!-- c: SAX-based multiple sink driver -->
      <transform style="../flatten.xsl">
        <output dest="${dir.output}/c1/output.txt"/>
        <output dest="${dir.output}/c2/output.txt"/>
      </transform>
    </chionographis>

    <assertfilenotexists name="${test.name} - c1" file="${dir.output}/c1/output.txt"/>
    <assertfilenotexists name="${test.name} - c2" file="${dir.output}/c2/output.txt"/>

    <delete dir="${dir.output}"/>
  </target>

</project>
