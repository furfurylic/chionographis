<project name="chinographis-test" basedir="." default="full">

    <taskdef name="chionographis" classname="net.furfurylic.chionographis.Chionographis"/>

    <target name="full">
        <antcall target="basic-mapper"/>
        <antcall target="basic-mapper-up-to-date"/>
        <antcall target="basic-refer-content"/>
        <antcall target="basic-force-output"/>
        <antcall target="basic-force-task"/>
        <antcall target="basic-up-to-date-at-start"/>
        <antcall target="basic-force-at-start"/>
        <antcall target="transform"/>
        <antcall target="transform-params"/>
        <antcall target="transform-params-ns"/>
        <antcall target="transform-refer-content"/>
        <antcall target="transform-not-up-to-date"/>
        <antcall target="transform-force"/>
        <antcall target="all"/>
        <antcall target="all-up-to-date"/>
        <antcall target="all-ns"/>
        <antcall target="all-force"/>
        <antcall target="snip-1"/>
        <antcall target="snip-2"/>
        <antcall target="snip-ns"/>
        <antcall target="crossing-cache"/>
    </target>

    <macrodef name="assertfileeq">
        <attribute name="name"/>
        <attribute name="expected"/>
        <attribute name="actual"/>
        <sequential>
            <fail message="@{name}: @{actual} doesn't exist">
                <condition><not><resourceexists><file file="@{actual}"/> </resourceexists></not></condition>
            </fail>
            <fail message="@{name}: @{expected} doesn't exist">
                <condition><not><resourceexists><file file="@{expected}"/> </resourceexists></not></condition>
            </fail>
            <fail message="@{name}: @{actual} doesn't match with @{expected}">
                <condition><not><filesmatch file1="@{actual}" file2="@{expected}"/></not></condition>
            </fail>
        </sequential>
    </macrodef>

    <macrodef name="assertfilelastmodified">
        <attribute name="name"/>
        <attribute name="file"/>
        <attribute name="datetime"/>
        <sequential>
            <fail message="@{name}: @{file} doesn't exist">
                <condition><not><resourceexists><file file="@{file}"/> </resourceexists></not></condition>
            </fail>
            <fail message="@{name}: @{file} doesn't have last modified time &quot;@{datetime}&quot;">
                <condition>
                    <not>
                        <islastmodified datetime="@{datetime}" mode="equals">
                            <file file="@{file}"/>
                        </islastmodified>
                    </not>
                </condition>
            </fail>
        </sequential>
    </macrodef>

    <target name="basic-mapper">
        <property name="test.prefix" value="basic"/>
        <property name="test.title" value="mapper"/>
        <property name="test.name" value="${test.prefix}-${test.title}"/>
        <property name="dir.input" location="${test.prefix}/input"/>
        <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

        <delete dir="${dir.output}"/>

        <chionographis basedir="${test.prefix}" srcdir="input" includes="*.xml">
            <output destdir="output-${test.title}" mkdirs="yes">
                <globmapper from="input*.xml" to="output*.xml"/>
            </output>
        </chionographis>

        <xslt style="${basedir}/flatten.xsl" basedir="${dir.output}" destdir="${dir.output}" includes="*.xml">
            <globmapper from="output*.xml" to="actual*.txt"/>
        </xslt>
        <assertfileeq name="${test.name} - 1" expected="${dir.input}/expected1.txt" actual="${dir.output}/actual1.txt"/>
        <assertfileeq name="${test.name} - 2" expected="${dir.input}/expected2.txt" actual="${dir.output}/actual2.txt"/>

        <delete dir="${dir.output}"/>
    </target>

    <target name="basic-mapper-up-to-date">
        <property name="test.prefix" value="basic"/>
        <property name="test.title" value="mapper-up-to-date"/>
        <property name="test.name" value="${test.prefix}-${test.title}"/>
        <property name="dir.input" location="${test.prefix}/input"/>
        <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

        <delete dir="${dir.output}"/>
        <mkdir dir="${dir.output}"/>
        <touch file="${dir.output}/output1.xml" datetime="01/01/2001 00:01:20 AM"/>

        <!-- input1: older -->
        <copy file="${dir.input}/input1.xml" tofile="${dir.output}/input1.xml"/>
        <touch file="${dir.output}/input1.xml" datetime="01/01/2001 00:01:10 AM"/>

        <!-- input2: newer -->
        <copy file="${dir.input}/input2.xml" tofile="${dir.output}/input2.xml"/>
        <touch file="${dir.output}/input2.xml" datetime="01/01/2001 00:01:30 AM"/>

        <chionographis srcdir="${test.prefix}/output-${test.title}" includes="input*.xml">
            <output destdir="${test.prefix}/output-${test.title}">
                <globmapper from="input*.xml" to="output*.xml"/>
            </output>
        </chionographis>

        <assertfilelastmodified name="${test.name}" file="${dir.output}/output1.xml" datetime="01/01/2001 00:01:20 AM"/>

        <delete dir="${dir.output}"/>
    </target>

    <target name="basic-refer-content">
        <property name="test.prefix" value="basic"/>
        <property name="test.title" value="refer-content"/>
        <property name="test.name" value="${test.prefix}-${test.title}"/>
        <property name="dir.input" location="${test.prefix}/input-${test.title}"/>
        <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

        <delete dir="${dir.output}"/>

        <chionographis basedir="basic" srcdir="input-${test.title}" includes="*.xml">
            <output destdir="output-${test.title}" refer="//processing-instruction('chionographis-output')[1]" mkdirs="yes"/>
            <output destdir="output-${test.title}" refer="//processing-instruction('chionographis-output')[1]" mkdirs="yes">
                <globmapper from="output*.xml" to="output*.2.xml"/>
            </output>
        </chionographis>

        <xslt style="${basedir}/flatten.xsl" basedir="${dir.output}" destdir="${dir.output}" includes="*.xml">
            <globmapper from="output*.xml" to="actual*.txt"/>
        </xslt>
        <assertfileeq name="${test.name} - 1" expected="${dir.input}/expected.txt" actual="${dir.output}/actual.txt"/>
        <assertfileeq name="${test.name} - 1" expected="${dir.input}/expected.txt" actual="${dir.output}/actual.2.txt"/>

        <delete dir="${dir.output}"/>
    </target>

    <target name="basic-force-output">
        <property name="test.prefix" value="basic"/>
        <property name="test.title" value="force-output"/>
        <property name="test.name" value="${test.prefix}-${test.title}"/>
        <property name="dir.input" location="${test.prefix}/input"/>
        <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

        <delete dir="${dir.output}"/>
        <mkdir dir="${dir.output}"/>
        <touch file="${dir.output}/output1.xml" datetime="01/01/2001 00:01:20 AM"/>

        <!-- input1: older -->
        <copy file="${dir.input}/input1.xml" tofile="${dir.output}/input1.xml"/>
        <touch file="${dir.output}/input1.xml" datetime="01/01/2001 00:01:10 AM"/>

        <!-- input2: newer -->
        <copy file="${dir.input}/input2.xml" tofile="${dir.output}/input2.xml"/>
        <touch file="${dir.output}/input2.xml" datetime="01/01/2001 00:01:30 AM"/>

        <!-- output1 shall not be processed and output2 shall be processed -->
        <chionographis srcdir="${test.prefix}/output-${test.title}" includes="input*.xml">
            <output destdir="${test.prefix}/output-${test.title}" force="yes">
                <globmapper from="input*.xml" to="output*.xml"/>
            </output>
        </chionographis>

        <xslt style="${basedir}/flatten.xsl" basedir="${dir.output}" destdir="${dir.output}" includes="*.xml">
            <globmapper from="output*.xml" to="actual*.txt"/>
        </xslt>
        <assertfileeq name="${test.name} - 1" actual="${dir.output}/actual1.txt" expected="${dir.input}/expected1.txt"/>
        <assertfileeq name="${test.name} - 2" actual="${dir.output}/actual2.txt" expected="${dir.input}/expected2.txt"/>

        <delete dir="${dir.output}"/>
    </target>

    <target name="basic-force-task">
        <property name="test.prefix" value="basic"/>
        <property name="test.title" value="force-task"/>
        <property name="test.name" value="${test.prefix}-${test.title}"/>
        <property name="dir.input" location="${test.prefix}/input"/>
        <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

        <delete dir="${dir.output}"/>
        <mkdir dir="${dir.output}"/>
        <touch file="${dir.output}/output1.xml" datetime="01/01/2001 00:01:20 AM"/>

        <!-- input1: older -->
        <copy file="${dir.input}/input1.xml" tofile="${dir.output}/input1.xml"/>
        <touch file="${dir.output}/input1.xml" datetime="01/01/2001 00:01:10 AM"/>

        <!-- input2: newer -->
        <copy file="${dir.input}/input2.xml" tofile="${dir.output}/input2.xml"/>
        <touch file="${dir.output}/input2.xml" datetime="01/01/2001 00:01:30 AM"/>

        <!-- output1 shall not be processed and output2 shall be processed -->
        <chionographis srcdir="${test.prefix}/output-${test.title}" includes="input*.xml" force="yes">
            <output destdir="${test.prefix}/output-${test.title}">
                <globmapper from="input*.xml" to="output*.xml"/>
            </output>
        </chionographis>

        <xslt style="${basedir}/flatten.xsl" basedir="${dir.output}" destdir="${dir.output}" includes="*.xml">
            <globmapper from="output*.xml" to="actual*.txt"/>
        </xslt>
        <assertfileeq name="${test.name} - 1" actual="${dir.output}/actual1.txt" expected="${dir.input}/expected1.txt"/>
        <assertfileeq name="${test.name} - 2" actual="${dir.output}/actual2.txt" expected="${dir.input}/expected2.txt"/>

        <delete dir="${dir.output}"/>
    </target>

    <target name="basic-up-to-date-at-start">
        <property name="test.prefix" value="basic"/>
        <property name="test.title" value="up-to-date-at-start"/>
        <property name="test.name" value="${test.prefix}-${test.title}"/>
        <property name="dir.input" location="${test.prefix}/input-${test.title}"/>
        <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

        <delete dir="${dir.output}"/>
        <mkdir dir="${dir.output}"/>

        <touch file="${dir.output}/output1.xml" datetime="01/01/2001 00:01:20 AM"/>
        <touch file="${dir.output}/output2.xml" datetime="01/01/2001 00:01:30 AM"/>

        <copy todir="${dir.output}">
            <fileset dir="${dir.input}" includes="*.xml"/>
        </copy>
        <!-- input1: older -->
        <touch file="${dir.output}/input1.xml" datetime="01/01/2001 00:01:10 AM"/>
        <!-- input2: newer -->
        <touch file="${dir.output}/input2.xml" datetime="01/01/2001 00:01:40 AM"/>

        <chionographis basedir="${dir.output}" includes="input*.xml" cache="yes">
            <output refer="/*/@num" mkdirs="yes">
                <globmapper from="*" to="output*.xml"/>
            </output>
        </chionographis>

        <xslt style="${basedir}/flatten.xsl" basedir="${dir.output}" destdir="${dir.output}" includes="output2.xml">
            <globmapper from="output*.xml" to="actual*.txt"/>
        </xslt>
        <assertfilelastmodified name="${test.name} - 1" file="${dir.output}/output1.xml" datetime="01/01/2001 00:01:20 AM"/>
        <assertfileeq name="${test.name}" expected="${dir.input}/expected2.txt" actual="${dir.output}/actual2.txt"/>

        <delete dir="${dir.output}"/>
    </target>

    <target name="basic-force-at-start">
        <property name="test.prefix" value="basic"/>
        <property name="test.title" value="force-at-start"/>
        <property name="test.name" value="${test.prefix}-${test.title}"/>
        <property name="dir.input" location="${test.prefix}/input-up-to-date-at-start"/>
        <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

        <delete dir="${dir.output}"/>
        <mkdir dir="${dir.output}"/>

        <touch file="${dir.output}/output1.xml" datetime="01/01/2001 00:01:20 AM"/>
        <touch file="${dir.output}/output2.xml" datetime="01/01/2001 00:01:30 AM"/>

        <copy todir="${dir.output}">
            <fileset dir="${dir.input}" includes="*.xml"/>
        </copy>
        <!-- input1 & 2: older -->
        <touch file="${dir.output}/input1.xml" datetime="01/01/2001 00:01:10 AM"/>
        <touch file="${dir.output}/input2.xml" datetime="01/01/2001 00:01:00 AM"/>

        <chionographis basedir="${dir.output}" includes="input*.xml" cache="yes" force="yes">
            <output refer="/*/@num" mkdirs="yes">
                <globmapper from="*" to="output*.xml"/>
            </output>
        </chionographis>

        <xslt style="${basedir}/flatten.xsl" basedir="${dir.output}" destdir="${dir.output}" includes="output*.xml">
            <globmapper from="output*.xml" to="actual*.txt"/>
        </xslt>
        <assertfileeq name="${test.name}" expected="${dir.input}/expected1.txt" actual="${dir.output}/actual1.txt"/>
        <assertfileeq name="${test.name}" expected="${dir.input}/expected2.txt" actual="${dir.output}/actual2.txt"/>

        <delete dir="${dir.output}"/>
    </target>

    <target name="transform">
        <property name="test.prefix" value="transform"/>
        <property name="test.name" value="${test.prefix}"/>
        <property name="dir.input" location="${test.prefix}/input"/>
        <property name="dir.output" location="${test.prefix}/output"/>

        <delete dir="${dir.output}"/>

        <chionographis basedir="${test.prefix}" includes="input/input.xml">
            <transform style="../flatten.xsl">
                <output dest="output/actual.txt" mkdirs="yes"/>
            </transform>
        </chionographis>

        <assertfileeq name="${test.name}" expected="${dir.input}/expected.txt" actual="${dir.output}/actual.txt"/>

        <delete dir="${dir.output}"/>
    </target>

    <target name="transform-params">
        <property name="test.prefix" value="transform"/>
        <property name="test.title" value="params"/>
        <property name="test.name" value="${test.prefix}-${test.title}"/>
        <property name="dir.input" location="${test.prefix}/input"/>
        <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

        <delete dir="${dir.output}"/>

        <chionographis basedir="${test.prefix}" includes="input/input.xml">
            <transform style="input/flatten-nons.xsl">
                <param name="p1">v1</param>
                <param name="p2">v2</param>
                <output dest="output-${test.title}/actual.txt" mkdirs="yes"/>
            </transform>
        </chionographis>

        <assertfileeq name="${test.name}" expected="${dir.input}/expected-params.txt" actual="${dir.output}/actual.txt"/>

        <delete dir="${dir.output}"/>
    </target>

    <target name="transform-params-ns">
        <property name="test.prefix" value="transform"/>
        <property name="test.title" value="params-ns"/>
        <property name="test.name" value="${test.prefix}-${test.title}"/>
        <property name="dir.input" location="${test.prefix}/input"/>
        <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

        <delete dir="${dir.output}"/>

        <chionographis basedir="${test.prefix}" includes="input/input.xml">
            <namespace prefix="p" uri="http://www.furfurylic.net/chionographis/test/transform/ns"/>
            <transform style="input/flatten-ns.xsl">
                <param name="p:p1">v1</param>
                <param name="{http://www.furfurylic.net/chionographis/test/transform/ns}p2">v2</param>
                <output dest="output-${test.title}/actual.txt" mkdirs="yes"/>
            </transform>
        </chionographis>

        <assertfileeq name="${test.name}" expected="${dir.input}/expected-params.txt" actual="${dir.output}/actual.txt"/>

        <delete dir="${dir.output}"/>
    </target>

    <target name="transform-refer-content">
        <property name="test.prefix" value="transform"/>
        <property name="test.title" value="refer-content"/>
        <property name="test.name" value="${test.prefix}-${test.title}"/>
        <property name="dir.input" location="${test.prefix}/input"/>
        <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

        <delete dir="${dir.output}"/>

        <chionographis includes="${test.prefix}/input/*-${test.title}.xml">
            <transform style="flatten.xsl">
                <output destdir="${test.prefix}/output-${test.title}" refer="/*/processing-instruction('chionographis-output')[1]" mkdirs="yes"/>
            </transform>
        </chionographis>

        <assertfileeq name="${test.name}" expected="${dir.input}/expected-${test.title}.txt" actual="${dir.output}/actual.txt"/>

        <delete dir="${dir.output}"/>
    </target>

    <target name="transform-not-up-to-date">
        <property name="test.prefix" value="transform"/>
        <property name="test.title" value="not-up-to-date"/>
        <property name="test.name" value="${test.prefix}-${test.title}"/>
        <property name="dir.input" location="${test.prefix}/input"/>
        <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

        <delete dir="${dir.output}"/>
        <mkdir dir="${dir.output}"/>

        <touch file="${dir.output}/actual.txt" datetime="01/01/2001 00:01:10 AM"/>

        <!-- input: older -->
        <copy file="transform/input/input.xml" todir="${dir.output}"/>
        <touch file="${dir.output}/input.xml" datetime="01/01/2001 00:01:00 AM"/>

        <!-- style: newer -->
        <copy file="flatten.xsl" todir="${dir.output}"/>
        <touch file="${dir.output}/flatten.xsl" datetime="01/01/2001 00:01:20 AM"/>

        <!-- Shall be processed -->
        <chionographis basedir="${test.prefix}" includes="input/input.xml">
            <transform style="output-${test.title}/flatten.xsl">
                <output dest="output-${test.title}/actual.txt" mkdirs="yes"/>
            </transform>
        </chionographis>

        <assertfileeq name="${test.name}" expected="transform/input/expected.txt" actual="${dir.output}/actual.txt"/>

        <delete dir="${dir.output}"/>
    </target>

    <target name="transform-force">
        <property name="test.prefix" value="transform"/>
        <property name="test.title" value="force"/>
        <property name="test.name" value="${test.prefix}-${test.title}"/>
        <property name="dir.input" location="${test.prefix}/input"/>
        <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

        <delete dir="${dir.output}"/>
        <mkdir dir="${dir.output}"/>

        <touch file="${dir.output}/actual.txt" datetime="01/01/2001 00:01:10 AM"/>

        <!-- input: older -->
        <copy file="transform/input/input.xml" todir="${dir.output}"/>
        <touch file="${dir.output}/input.xml" datetime="01/01/2001 00:01:00 AM"/>

        <!-- style: older -->
        <copy file="flatten.xsl" todir="${dir.output}"/>
        <touch file="${dir.output}/flatten.xsl" datetime="01/01/2001 00:00:50 AM"/>

        <!-- Shall be processed -->
        <chionographis basedir="${test.prefix}" includes="input/input.xml">
            <transform style="output-${test.title}/flatten.xsl" force="yes">
                <output dest="output-${test.title}/actual.txt" mkdirs="yes"/>
            </transform>
        </chionographis>

        <assertfileeq name="${test.name}" expected="${dir.input}/expected.txt" actual="${dir.output}/actual.txt"/>

        <delete dir="${dir.output}"/>
    </target>

    <target name="all">
        <property name="test.prefix" value="all"/>
        <property name="test.name" value="${test.prefix}"/>
        <property name="dir.input" location="${test.prefix}/input"/>
        <property name="dir.output" location="${test.prefix}/output"/>

        <delete dir="${dir.output}"/>

        <chionographis basedir="${test.prefix}" includes="input/*.xml">
            <all root="q">
                <output dest="output/output.xml" mkdirs="yes"/>
            </all>
        </chionographis>

        <xslt style="${basedir}/flatten.xsl" in="${dir.output}/output.xml" out="${dir.output}/actual.txt"/>
        <assertfileeq name="${test.name}" expected="${dir.input}/expected.txt" actual="${dir.output}/actual.txt"/>

        <delete dir="${dir.output}"/>
    </target>

    <target name="all-up-to-date">
        <property name="test.prefix" value="all"/>
        <property name="test.title" value="up-to-date"/>
        <property name="test.name" value="${test.prefix}-${test.title}"/>
        <property name="dir.input" location="${test.prefix}/input"/>
        <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

        <delete dir="${dir.output}"/>
        <mkdir dir="${dir.output}"/>

        <touch file="${dir.output}/output.xml" datetime="01/01/2001 00:01:20 AM"/>

        <!-- input1 and 2: older -->
        <copy todir="${dir.output}">
            <fileset dir="all/input" includes="*.xml"/>
        </copy>
        <touch file="${dir.output}/input1.xml" datetime="01/01/2001 00:01:10 AM"/>
        <touch file="${dir.output}/input2.xml" datetime="01/01/2001 00:01:00 AM"/>

        <!-- Shall not be processed -->
        <chionographis basedir="${test.prefix}" includes="output-${test.title}/input*.xml">
            <all root="q" force="no">
                <output dest="output-${test.title}/output.xml"/>
            </all>
        </chionographis>

        <assertfilelastmodified name="${test.name}" file="${dir.output}/output.xml" datetime="01/01/2001 00:01:20 AM"/>

        <delete dir="${dir.output}"/>
    </target>

    <target name="all-ns">
        <property name="test.prefix" value="all"/>
        <property name="test.title" value="ns"/>
        <property name="test.name" value="${test.prefix}-${test.title}"/>
        <property name="dir.input" location="${test.prefix}/input-${test.title}"/>
        <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

        <delete dir="${dir.output}"/>

        <chionographis basedir="${test.prefix}" includes="input-${test.title}/*.xml">
            <namespace prefix="all" uri="http://www.furfurylic.net/chionographis/test/all/ns/task1"/>
            <all root="all:p">
                <all root="{http://www.furfurylic.net/chionographis/test/all/ns/task2}q">
                    <output dest="output-${test.title}/output.xml" mkdirs="yes"/>
                </all>
            </all>
        </chionographis>

        <xslt style="${basedir}/flatten.xsl" in="${dir.output}/output.xml" out="${dir.output}/actual.txt"/>
        <assertfileeq name="${test.name}" expected="${dir.input}/expected.txt" actual="${dir.output}/actual.txt"/>

        <delete dir="${dir.output}"/>
    </target>

    <target name="all-force">
        <property name="test.prefix" value="all"/>
        <property name="test.title" value="force"/>
        <property name="test.name" value="${test.prefix}-${test.title}"/>
        <property name="dir.input" location="${test.prefix}/input"/>
        <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

        <delete dir="${dir.output}"/>
        <mkdir dir="${dir.output}"/>

        <touch file="${dir.output}/output.xml" datetime="01/01/2001 00:01:20 AM"/>

        <!-- input1 and 2: older -->
        <copy todir="${dir.output}">
            <fileset dir="all/input" includes="*.xml"/>
        </copy>
        <touch file="${dir.output}/input1.xml" datetime="01/01/2001 00:01:10 AM"/>
        <touch file="${dir.output}/input2.xml" datetime="01/01/2001 00:01:00 AM"/>

        <!-- Shall BE processed -->
        <chionographis basedir="${test.prefix}" includes="output-${test.title}/input*.xml">
            <all root="q">
                <output dest="output-${test.title}/output.xml"/>
            </all>
        </chionographis>

        <xslt style="${basedir}/flatten.xsl" in="${dir.output}/output.xml" out="${dir.output}/actual.txt"/>
        <assertfileeq name="${test.name}"  expected="${dir.input}/expected.txt" actual="${dir.output}/actual.txt"/>

        <delete dir="${dir.output}"/>
    </target>

    <target name="snip-1">
        <property name="test.prefix" value="snip"/>
        <property name="test.title" value="1"/>
        <property name="test.name" value="${test.prefix}-${test.title}"/>
        <property name="dir.input" location="${test.prefix}/input${test.title}"/>
        <property name="dir.output" location="${test.prefix}/output${test.title}"/>

        <delete dir="${dir.output}"/>

        <chionographis srcdir="${test.prefix}/input${test.title}" includes="*.xml">
            <snip select="//b">
                <output destdir="${test.prefix}/output${test.title}" refer="//processing-instruction('chionographis-output')" mkdirs="yes"/>
            </snip>
        </chionographis>

        <xslt style="${basedir}/flatten.xsl" basedir="${dir.output}" destdir="${dir.output}" includes="*.xml">
            <globmapper from="output*.xml" to="actual*.txt"/>
        </xslt>
        <assertfileeq name="${test.name} - 1a" expected="${dir.input}/expected1a.txt" actual="${dir.output}/actual1a.txt"/>
        <assertfileeq name="${test.name} - 1b" expected="${dir.input}/expected1b.txt" actual="${dir.output}/actual1b.txt"/>

        <delete dir="${dir.output}"/>
    </target>

    <target name="snip-2">
        <property name="test.prefix" value="snip"/>
        <property name="test.title" value="2"/>
        <property name="test.name" value="${test.prefix}-${test.title}"/>
        <property name="dir.input" location="${test.prefix}/input${test.title}"/>
        <property name="dir.output" location="${test.prefix}/output${test.title}"/>

        <delete dir="${dir.output}"/>

        <chionographis srcdir="${test.prefix}/input${test.title}" includes="*.xml">
            <snip select="a/b">
                <output destdir="${test.prefix}/output${test.title}" refer="//processing-instruction('chionographis-output')" mkdirs="yes"/>
            </snip>
        </chionographis>

        <xslt style="${basedir}/flatten.xsl" basedir="${dir.output}" destdir="${dir.output}" includes="*.xml">
            <globmapper from="output*.xml" to="actual*.txt"/>
        </xslt>
        <assertfileeq name="${test.name} - 1a" expected="${dir.input}/expected1a.txt" actual="${dir.output}/actual1a.txt"/>
        <assertfileeq name="${test.name} - 1b" expected="${dir.input}/expected1b.txt" actual="${dir.output}/actual1b.txt"/>
        <assertfileeq name="${test.name} - 2a" expected="${dir.input}/expected2a.txt" actual="${dir.output}/actual2a.txt"/>

        <delete dir="${dir.output}"/>
    </target>

    <target name="snip-ns">
        <property name="test.prefix" value="snip"/>
        <property name="test.title" value="ns"/>
        <property name="test.name" value="${test.prefix}-${test.title}"/>
        <property name="dir.input" location="${test.prefix}/input-${test.title}"/>
        <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

        <delete dir="${dir.output}"/>

        <chionographis srcdir="${test.prefix}/input-${test.title}" includes="*.xml">
            <namespace prefix="q" uri="http://www.furfurylic.net/chionographis/test"/>
            <snip select="//q:a[2]">
                <output destdir="${test.prefix}/output-${test.title}" refer="//processing-instruction('chionographis-output')" mkdirs="yes"/>
            </snip>
        </chionographis>

        <xslt style="${basedir}/flatten.xsl" basedir="${dir.output}" destdir="${dir.output}" includes="*.xml">
            <globmapper from="output*.xml" to="actual*.txt"/>
        </xslt>
        <assertfileeq name="${test.name}" expected="${dir.input}/expected2.txt" actual="${dir.output}/actual2.txt"/>

        <delete dir="${dir.output}"/>
    </target>

    <target name="crossing-cache">
        <property name="test.prefix" value="crossing"/>
        <property name="test.title" value="cache"/>
        <property name="test.name" value="${test.prefix}-${test.title}"/>
        <property name="dir.input" location="${test.prefix}/input-${test.title}"/>
        <property name="dir.output" location="${test.prefix}/output-${test.title}"/>

        <delete dir="${dir.output}"/>

        <chionographis basedir="${test.prefix}/input-${test.title}" includes="input.xml" cache="yes" verbose="yes">
            <transform style="style1.xsl" cache="yes">
                <output dest="../output-${test.title}/actual1.txt" mkdirs="yes"/>
            </transform>
            <transform style="style2.xsl" cache="yes">
                <output dest="../output-${test.title}/actual2.txt" mkdirs="yes"/>
            </transform>
        </chionographis>

        <assertfileeq name="${test.name} - 1" expected="${dir.input}/expected1.txt" actual="${dir.output}/actual1.txt"/>
        <assertfileeq name="${test.name} - 2" expected="${dir.input}/expected2.txt" actual="${dir.output}/actual2.txt"/>

        <delete dir="${dir.output}"/>
    </target>

</project>
